<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.290">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-03-01">
<meta name="description" content="Using a hierarchical Bayesian model to analyze and compare excess mortality due to Covid-19 in the German states.">

<title>iammees - Building a Hierarchical Model For Estimating Covid-19 Excess Mortality</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">iammees</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/iammees" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Building a Hierarchical Model For Estimating Covid-19 Excess Mortality</h1>
                  <div>
        <div class="description">
          Using a hierarchical Bayesian model to analyze and compare excess mortality due to Covid-19 in the German states.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 1, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>For grouped data, Bayesian modeling offers three basic techniques: pooled models that assume no distinction between groups (i.e., <em>pooling</em> all information), unpooled models that assume a complete distinction between groups (i.e., considering all groups separately), and partially pooled (or hierarchical) models which allow each group to have its own model but also assume that groups can provide information about another. In this blog post, we’ll build a hierarchical model for estimating excess mortality in the German states. For the probabilistic programming part, we’ll use <a href="https://www.pymc.io/welcome.html">PyMC</a>.</p>
<div class="cell" data-execution_count="110">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.gridspec <span class="im">import</span> GridSpec</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> MultipleLocator, FuncFormatter</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.offsetbox <span class="im">import</span> OffsetImage, AnnotationBbox</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> calendar</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> timedelta</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc.sampling_jax</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytensor.tensor <span class="im">as</span> at</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> patsy <span class="im">import</span> dmatrix</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="67">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_datasets(df):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df.year <span class="op">&gt;=</span> <span class="dv">2010</span>]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    pre_df <span class="op">=</span> df[df[<span class="st">"is_pre_covid"</span>]].copy().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    post_df <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">"is_pre_covid"</span>]].copy().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> [<span class="st">"mean_temp"</span>, </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_per100k"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_per100k_lag1"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_75_79_per100k"</span>, </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_75_79_per100k_lag1"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_75_79_per100k_lag2"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_gt80_per100k"</span>, </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_gt80_per100k_lag1"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_gt80_per100k_lag2"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_last_year"</span>, </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_per100k"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_per100k_lag1"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_75_79_per100k"</span>, </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_75_79_per100k_lag1"</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_75_79_per100k_lag2"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_gt80_per100k"</span>, </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_gt80_per100k_lag1"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_gt80_per100k_lag2"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_last_year"</span>]:</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        ss <span class="op">=</span> StandardScaler()</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        ss.fit(pre_df[feature].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        pre_df[<span class="ss">f"</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">_st"</span>] <span class="op">=</span> ss.transform(pre_df[feature].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).ravel()</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        post_df[<span class="ss">f"</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">_st"</span>] <span class="op">=</span> ss.transform(post_df[feature].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).ravel()</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pre_df, post_df</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_plot(figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">4</span>), title<span class="op">=</span><span class="va">None</span>, xlabel<span class="op">=</span><span class="va">None</span>, ylabel<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    _, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>figsize)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    ax.grid(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, color<span class="op">=</span><span class="st">"#e6e5e3"</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"both"</span>, labelsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_linewidth(<span class="fl">1.1</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>        ax.set_title(title, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> xlabel <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(xlabel, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ylabel <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(ylabel, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="65">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> Path(<span class="st">"../data/final/germany.ftr"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_feather(data_path)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>pre_df, post_df <span class="op">=</span> create_datasets(df.copy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The Problem</h2>
<p>In Germany it has been a matter of fierce debate whether patients whose deaths were officially reported as being “associated with Covid-19” have died <em>due to</em> or <em>with</em> Covid-19. Providing a reliable answer to this question boils down to estimating excess mortality. The total number of recorded deaths is not only readily available but also unaffected by the (quite contentious) definition of Covid-19 deaths, and can therefore serve as an objective metric.</p>
<p>It turns out that the common approach is to compare weekly mortality numbers of the year in question with the median of some reference years. The <a href="https://www.destatis.de/DE/Home/_inhalt.html">Federal Statistical Office of Germany (destatis)</a>, for example, estimates excess mortality by comparing weekly deaths of a given year with the weekly median of the four previous years, yielding figures like the one that I recreated below for the year 2022 (see <a href="https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/sterbefallzahlen.html">here</a> for the analysis by destatis).</p>
<div class="cell" data-execution_count="70">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_compare_past(df, year):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    df_year <span class="op">=</span> df[df.year <span class="op">==</span> year][[<span class="st">"week"</span>, <span class="st">"deaths_total"</span>, <span class="st">"covid_deaths"</span>]]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    df_past <span class="op">=</span> df[df.year.isin(<span class="bu">range</span>(year <span class="op">-</span> <span class="dv">4</span>, year))].groupby(<span class="st">"week"</span>).deaths_total.agg([<span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"max"</span>]).reset_index()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_year.shape[<span class="dv">0</span>] <span class="op">&gt;</span> df_past.shape[<span class="dv">0</span>]:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        week53 <span class="op">=</span> pd.DataFrame(df_past.iloc[<span class="dv">0</span>]).T</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        week53[<span class="st">"week"</span>] <span class="op">=</span> <span class="dv">53</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        df_past <span class="op">=</span> pd.concat([df_past, week53])</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> df_year.shape[<span class="dv">0</span>] <span class="op">&lt;</span> df_past.shape[<span class="dv">0</span>]:</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        df_past <span class="op">=</span> df_past.iloc[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    _, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">3</span>))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    ax.plot(df_year.week, df_year.deaths_total, color<span class="op">=</span><span class="st">"#ec4c62"</span>, zorder<span class="op">=</span><span class="dv">5</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> year <span class="op">&gt;</span> <span class="dv">2019</span>:</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        ax.plot(df_year.week, df_year.covid_deaths, color<span class="op">=</span><span class="st">"#ec4c62"</span>, marker<span class="op">=</span><span class="st">"o"</span>, markersize<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> Covid-19"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    ax.plot(df_past.week, df_past[<span class="st">"median"</span>], color<span class="op">=</span><span class="st">"#005890"</span>, lw<span class="op">=</span><span class="fl">.75</span>, zorder<span class="op">=</span><span class="dv">4</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>year<span class="op">-</span><span class="dv">4</span><span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>year<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> median"</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    ax.fill_between(df_past.week, df_past[<span class="st">"min"</span>], df_past[<span class="st">"max"</span>], color<span class="op">=</span><span class="st">"#acddfd"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, zorder<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>year<span class="op">-</span><span class="dv">4</span><span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>year<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> min/max"</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"left"</span>, <span class="st">"bottom"</span>]:</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_linewidth(<span class="fl">0.5</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"calendar week"</span>, fontsize<span class="op">=</span><span class="fl">9.5</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"weekly</span><span class="ch">\n</span><span class="st">deaths"</span>, rotation<span class="op">=</span><span class="st">"horizontal"</span>, labelpad<span class="op">=</span><span class="dv">25</span>, fontsize<span class="op">=</span><span class="fl">9.5</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim((<span class="fl">0.5</span>, df_past.shape[<span class="dv">0</span>] <span class="op">+</span> <span class="fl">0.5</span>))</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim((<span class="dv">0</span>, <span class="dv">34_000</span>))</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_locator(MultipleLocator(<span class="dv">1</span>))</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(MultipleLocator(<span class="dv">5</span>))</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_major_locator(MultipleLocator(<span class="dv">5_000</span>))</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_major_formatter(FuncFormatter(<span class="kw">lambda</span> x, _: <span class="bu">format</span>(<span class="bu">int</span>(x), <span class="st">','</span>)))</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"minor"</span>, labelbottom<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, left<span class="op">=</span><span class="va">False</span>, labelsize<span class="op">=</span><span class="dv">9</span>, pad<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.grid(<span class="va">True</span>, which<span class="op">=</span><span class="st">"major"</span>, color<span class="op">=</span><span class="st">"#e6e6e6"</span>, zorder<span class="op">=-</span><span class="dv">10</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">"upper center"</span>, prop<span class="op">=</span>{<span class="st">"size"</span>: <span class="dv">8</span>}, facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="71">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>plot_compare_past(df, <span class="dv">2022</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-6-output-1.png" class="quarto-discovered-preview-image img-fluid"></p>
</div>
</div>
<p>While this approach can certainly help detect major patterns in mortality during the course of a year, there are two drawbacks worth considering:</p>
<ol type="1">
<li>The comparison solely depends on the mortality in the reference years which leads to arbitrary weekly patterns and limited comparability across a broader timeframe and across countries. When it comes to estimating excess mortality due to Covid-19, the approach will fail at the latest when the reference years have already been impacted by Covid-19.</li>
<li>By design the method doesn’t consider the influence of other factors which are known to impact mortality rates. For instance, not taking the aging of Germany’s population into account will inevitably lead to an overestimation of excess mortality (the aging is only partly offset by an increase in life expectancy). There are papers which tried to mitigate this by extrapolating from the reference years (e.g., see <a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0255540">here</a> and <a href="https://www.ifo.de/DocDL/ifoDD_22-01_29-35_Ragnitz.pdf">here</a>), but they still neglect other important effects.</li>
</ol>
<p>So can we build a model explicitly for estimating Covid-19 excess mortality? Before we get into the specifics, it is essential to establish a precise understanding of what we actually mean by “Covid-19 excess mortality”. Excess deaths due to Covid-19 are deaths that would not have occurred if Covid-19 had not appeared. Expressed mathematically, excess deaths are the difference between actual deaths and expected deaths.</p>
<p>But since <em>expected</em> deaths are an unmeasurable quantity this appears to be simpler than it actually is. The crucial question now is: How many deaths should we <em>expect</em>? Or, more precisely and with our specific problem in mind: How many deaths should we expect in a counterfactual scenario with no pandemic? To see the point, let’s pause and think only about the role of seasonal influenza. The severity of the yearly influenza wave depends on many factors and is therefore very hard to predict. In some years (e.g., 2014) the wave is mild, while in other years (e.g., 2018) the death toll is very high. Intuitively, one would probably assert that influenza led to no or very few excess deaths in 2014, while the severe wave of 2018 led to significant excess mortality. So how many deaths should we expect for, say, 2021? Following the intuition that we just developed, our expectation <em>should depend on the severity of the flu wave</em> in 2021. Thus, given that Covid-19 mitigation measures like mask mandates and social distancing had the side effect of virtually no flu cases, we shouldn’t expect any influenza-related deaths. This brings us back to the problems of the baseline approach outlined earlier. If we compared 2021 with the median of the four previous years, the estimated excess deaths would be heavily biased by the flu activity in these years. (The same logic applies to other factors like temperature, of course.) Indeed, a 2022 <a href="https://onlinelibrary.wiley.com/doi/10.1111/padr.12475">study</a> found that the choice of baseline years is highly influential for the resulting estimate of excess deaths. In Germany, using the four previous years as a baseline <a href="https://www.demogr.mpg.de/en/news_events_6123/news_press_releases_4630/news/how_to_calculate_excess_mortality_to_better_estimate_the_impact_of_the_pandemic_10474">would lead to a significant undercount</a> of Covid-19 deaths.</p>
<p>Thus, what we’ll do instead is build a model that is trained on data before the spread of Covid-19 and capable of accurately predicting weekly mortality figures. We’ll use this model to create a counterfactual forecast of mortality for the years impacted by Covid-19 which we will then compare with the number of deaths that were actually reported. Naturally, this approach still has limitations (which are exacerbated by data availability issues); in particular, the number of excess deaths will not only include deaths that were directly caused by the virus, but also deaths that were caused indirectly (e.g., due to worse access to health care) or even indirectly prevented (e.g., less traffic accidents during lockdowns). We should keep this in mind when analyzing our results later.</p>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The Data</h2>
<p>I could gather the following weekly data which I have already cleaned, aggregated and split into <code>pre_df</code> (covering the years 2005-2019, not affected by Covid-19) and <code>post_df</code> (since 2020, affected by the spread of Covid-19):</p>
<ul>
<li>The weekly number of deaths from destatis (<a href="https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/Tabellen/sonderauswertung-sterbefaelle-endgueltige-daten.html">2000-2015</a>, <a href="https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/Tabellen/sonderauswertung-sterbefaelle.html">2016-2022</a>)</li>
<li>Population data from destatis (<a href="https://www-genesis.destatis.de/genesis//online?operation=table&amp;code=12411-0005&amp;bypass=true&amp;levelindex=0&amp;levelid=1670263168957">1970-2021</a>, extrapolated to 2022)</li>
<li>The average weekly minimum, mean, and maximum temperatures from official weather stations operated by the German Meteorological Service (DWD) (<a href="https://opendata.dwd.de/climate_environment/CDC/observations_germany/climate/daily/kl/historical/">-2021</a>, <a href="https://opendata.dwd.de/climate_environment/CDC/observations_germany/climate/daily/kl/recent/">2022-</a>)</li>
<li>Disease data (cases numbers for influenza and other viral or bacterial diseases) from the Robert Koch Institute (RKI), Germany’s government agency for disease control and prevention (<a href="https://survstat.rki.de/Content/Query/Create.aspx">2005-2022</a>)</li>
<li>Data related to Covid-19 from the RKI (<a href="https://github.com/robert-koch-institut">2020-</a>)</li>
</ul>
<p>Let’s have a quick look at the aggregate data for Germany:</p>
<section id="reported-deaths" class="level3">
<h3 class="anchored" data-anchor-id="reported-deaths">Reported deaths</h3>
<p>When we plot the weekly deaths per 100,000 people since the year 2010, we immediately notice two things: the number of deaths increases over the years and there is marked seasonality. Meanwhile it is quite hard to see (at least at first glance) whether the years 2020-2022 really are exceptional.</p>
<div class="cell" data-execution_count="72">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> get_plot(ylabel<span class="op">=</span><span class="st">"weekly deaths per 100,000 people"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ax.plot(pre_df.date, pre_df.deaths_per100k, color<span class="op">=</span><span class="st">"#0e448a"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>ax.plot(post_df.date, post_df.deaths_per100k, color<span class="op">=</span><span class="st">"#991608"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>ax.set_xlim([pre_df.date.<span class="bu">min</span>() <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">50</span>), post_df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">100</span>)])</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, rotation<span class="op">=</span><span class="dv">45</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="seasonality" class="level3">
<h3 class="anchored" data-anchor-id="seasonality">Seasonality</h3>
<p>Let’s have a closer look at the seasonality. To get a better grasp of the seasonal patterns, we can plot the number of deaths for all years in <code>pre_df</code> by calendar week.</p>
<p>A lot of the seasonality that we can see here has probably to do with temperature effects. As even moderately cold temperatures are known to worsen pre-existing medical conditions like cardiovascular and respiratory diseases, it is not surprising that more deaths are recorded in winter. However, the peaks in summer show that heat waves take their toll too.</p>
<p>The high mortality in February/March reflects the peaks of flu season. Apart from that the seasonality surely involves other effects that are more loosely related to temperature (e.g., seasonal activities or traffic conditions that are associated with higher mortality).</p>
<p>Finally note that the color-coding of the years highlights the rise in mortality over the years once more.</p>
<div class="cell" data-execution_count="73">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> get_plot(ylabel<span class="op">=</span><span class="st">"weekly deaths per 100,000 people"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>pre_df, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>             x<span class="op">=</span><span class="st">"week"</span>, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>             y<span class="op">=</span><span class="st">"deaths_per100k"</span>, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>             hue<span class="op">=</span><span class="st">"year"</span>, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>             palette<span class="op">=</span>sns.cubehelix_palette(start<span class="op">=</span><span class="fl">.2</span>, rot<span class="op">=-</span><span class="fl">.3</span>, as_cmap<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_locator(MultipleLocator(<span class="dv">5</span>))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">1</span>, <span class="dv">54</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>handles, labels <span class="op">=</span> ax.get_legend_handles_labels()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>ax.legend(handles<span class="op">=</span>handles[::<span class="op">-</span><span class="dv">1</span>], </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>          labels<span class="op">=</span>labels[::<span class="op">-</span><span class="dv">1</span>], </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>          facecolor<span class="op">=</span><span class="st">"white"</span>, </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>          edgecolor<span class="op">=</span><span class="st">"white"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="temperature" class="level3">
<h3 class="anchored" data-anchor-id="temperature">Temperature</h3>
<p>The relationship between the number of deaths and mean temperature is quite clear. While moderate temperatures are associated with the lowest mortality, colder temperatures and excessive heat increase the number of deaths.</p>
<div class="cell" data-execution_count="74">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> get_plot(xlabel<span class="op">=</span><span class="st">"mean temperature"</span>, ylabel<span class="op">=</span><span class="st">"weekly deaths per 100,000 people"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ax.scatter(pre_df.mean_temp, pre_df.deaths_per100k, color<span class="op">=</span><span class="st">"#4c88d4"</span>, edgecolor<span class="op">=</span><span class="st">"#020e78"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, s<span class="op">=</span><span class="dv">20</span>, zorder<span class="op">=</span><span class="dv">2</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="influenza" class="level3">
<h3 class="anchored" data-anchor-id="influenza">Influenza</h3>
<p>Finally, let’s have a look at influenza. We can plot the number of flu cases (here only the age groups 75-79 and 80+) against the number of weekly deaths:</p>
<div class="cell" data-execution_count="75">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> get_plot(xlabel<span class="op">=</span><span class="st">"number of flu cases (log scale)"</span>, ylabel<span class="op">=</span><span class="st">"weekly deaths per 100,000 people"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ax.scatter(np.log(pre_df[pre_df.flu_cases <span class="op">&gt;</span> <span class="dv">0</span>].flu_cases_75_79_per100k), pre_df[pre_df.flu_cases <span class="op">&gt;</span> <span class="dv">0</span>].deaths_per100k, color<span class="op">=</span><span class="st">"#4c88d4"</span>, edgecolor<span class="op">=</span><span class="st">"#020e78"</span>, alpha<span class="op">=</span><span class="fl">0.65</span>, s<span class="op">=</span><span class="dv">20</span>, zorder<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"age group 75-79"</span>)<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>ax.scatter(np.log(pre_df[pre_df.flu_cases <span class="op">&gt;</span> <span class="dv">0</span>].flu_cases_gt80_per100k), pre_df[pre_df.flu_cases <span class="op">&gt;</span> <span class="dv">0</span>].deaths_per100k, color<span class="op">=</span><span class="st">"#0e448a"</span>, edgecolor<span class="op">=</span><span class="st">"#03093b"</span>, alpha<span class="op">=</span><span class="fl">0.65</span>, s<span class="op">=</span><span class="dv">20</span>, zorder<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"age group 80+"</span>)<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>ax.legend(facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>As we can see, the case numbers will likely be useful predictors. Also, note that influenza is highly seasonal and there were very few cases in the years affected by Covid-19:</p>
<div class="cell" data-execution_count="76">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> get_plot(ylabel<span class="op">=</span><span class="st">"number of cases"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ax.plot(pre_df[pre_df.flu_cases <span class="op">&gt;</span> <span class="dv">0</span>].date, pre_df[pre_df.flu_cases <span class="op">&gt;</span> <span class="dv">0</span>].flu_cases, color<span class="op">=</span><span class="st">"#4c88d4"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ax.plot(post_df[post_df.flu_cases <span class="op">&gt;</span> <span class="dv">0</span>].date, post_df[post_df.flu_cases <span class="op">&gt;</span> <span class="dv">0</span>].flu_cases, color<span class="op">=</span><span class="st">"#4c88d4"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.YearLocator())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-11-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="the-base-model" class="level2">
<h2 class="anchored" data-anchor-id="the-base-model">The Base Model</h2>
<p>As advertised, we’ll tackle our problem with a Bayesian model (in particular, a Bayesian linear regression model) specified with PyMC. Using a Bayesian model comes with two great advantages: A natural and principled way to incorporate prior knowledge and an intuitive way to quantify uncertainty with probabilities.</p>
<p>We’ll begin with a model for Germany. I’ll spare the reader from the iterative process that ultimately resulted in the model presented below, but let’s go over the main modeling and feature selection choices:</p>
<ul>
<li>To model the seasonality we use PyMC’s nifty <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.ZeroSumNormal.html"><code>ZeroSumNormal</code> distribution</a> for monthly effects (<code>month_mu</code>). This means that the monthly effects will sum to zero improving both parameter identifiability and interpretability.</li>
<li>The effect of mean temperature (<code>temp</code>) on mortality is modeled using splines. We’ve already seen why this should improve model performance when we plotted mean temperature against weekly deaths. See <a href="https://www.pymc.io/projects/examples/en/latest/case_studies/spline.html">here</a> and <a href="https://bayesiancomputationbook.com/markdown/chp_05.html">here</a> for great resources on splines.</li>
<li>A little research (e.g., this <a href="https://bmcpublichealth.biomedcentral.com/articles/10.1186/s12889-016-3031-z">paper</a>) showed that while heat waves affect mortality quite immediately, the effect of cold temperatures can have a considerable lag. For this reason we add two dummy variables that indicate whether the average minimum temperature of the last and second last week was below 0 degrees Celsius (<code>temp_lag1</code> and <code>temp_lag2</code>).</li>
<li>To factor in the age of the German population we include the population share of the age groups 70-74, 75-79, and 80+ (<code>age_70</code>, <code>age_75</code>, and <code>age_80</code>). We center these features for better interpretability.</li>
<li>The last main block of features concerns the role of influenza/other diseases. While we use the number of cases in the age groups 75-79 and 80+ of the previous week for influenza (<code>flu_7579_lag1</code>, <code>flu_gt80_lag1</code>), we use the case numbers of the current week for the generic category of other viral or bacterial diseases (<code>disease_7579</code>, <code>disease_gt80</code>). (These features are all standardized for easier interpretability.) For both categories we also include the number of cases reported in the last year (<code>[flu/disease]_last_year</code>) since population-level immunity obtained in a given year <a href="https://www.rki.de/SharedDocs/FAQ/Influenza/FAQ_Liste.html">tends to dampen the severity of next year’s wave</a>.</li>
<li>Finally, we include some interactions that should further improve the model: <code>temp:flu</code>, <code>flu:disease</code>, and <code>disease:age_80</code> (where <code>flu</code>/<code>disease</code> represent the weekly number of cases per 100,000 people for each category).</li>
</ul>
<p>Specifying this model with reasonable priors in PyMC is fairly straightforward. Note that we wrap the model building in a factory function to make our life a lot <a href="https://discourse.pymc.io/t/unable-to-predict-using-set-value-with-an-errors-in-variables-model/5236/5">easier</a> when we compute the counterfactual forecast for the years affected by Covid-19.</p>
<div class="cell" data-execution_count="77">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model(pre_df, post_df, infer_post<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pre_df <span class="cf">if</span> <span class="kw">not</span> infer_post <span class="cf">else</span> post_df</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    knot_list <span class="op">=</span> np.quantile(pre_df.mean_temp, np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">5</span>))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> dmatrix(<span class="st">"0 + bs(mean_temp, knots=knots, degree=2, include_intercept=True)"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"mean_temp"</span>: df.mean_temp.values, <span class="st">"knots"</span>: knot_list[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]})</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    coords <span class="op">=</span> {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month"</span>: calendar.month_name[<span class="dv">1</span>:],</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"splines"</span>: np.arange(B.shape[<span class="dv">1</span>])</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords) <span class="im">as</span> model:</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># observed data</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> pm.MutableData(<span class="st">"month"</span>, df[<span class="st">"month"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        temp <span class="op">=</span> pm.MutableData(<span class="st">"temp"</span>, df[<span class="st">"mean_temp_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        temp_lag1 <span class="op">=</span> pm.MutableData(<span class="st">"temp lag1"</span>, df[<span class="st">"min_lt0_lag1"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        temp_lag2 <span class="op">=</span> pm.MutableData(<span class="st">"temp lag2"</span>, df[<span class="st">"min_lt0_lag2"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        age_70 <span class="op">=</span> pm.MutableData(<span class="st">"age 70-75"</span>, df[<span class="st">"pop_share_70_74_cnt"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        age_75 <span class="op">=</span> pm.MutableData(<span class="st">"age 75-80"</span>, df[<span class="st">"pop_share_75_79_cnt"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        age_80 <span class="op">=</span> pm.MutableData(<span class="st">"age 80+"</span>, df[<span class="st">"pop_share_gt80_cnt"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        flu <span class="op">=</span> pm.MutableData(<span class="st">"flu cases per 100k"</span>, df[<span class="st">"flu_cases_per100k_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        flu_75_lag1 <span class="op">=</span> pm.MutableData(<span class="st">"flu cases age 75-79 per 100k lag1"</span>, df[<span class="st">"flu_cases_75_79_per100k_lag1_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        flu_80_lag1 <span class="op">=</span> pm.MutableData(<span class="st">"flu cases age 80+ per 100k lag1"</span>, df[<span class="st">"flu_cases_gt80_per100k_lag1_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        flu_last_year <span class="op">=</span> pm.MutableData(<span class="st">"flu cases last year"</span>, df[<span class="st">"flu_last_year_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        disease <span class="op">=</span> pm.MutableData(<span class="st">"disease cases per 100k"</span>, df[<span class="st">"disease_cases_per100k_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        disease_75 <span class="op">=</span> pm.MutableData(<span class="st">"disease cases age 75-79 per 100k"</span>, df[<span class="st">"disease_cases_75_79_per100k_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        disease_80 <span class="op">=</span> pm.MutableData(<span class="st">"disease cases age 80+ per 100k"</span>, df[<span class="st">"disease_cases_gt80_per100k_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        disease_last_year <span class="op">=</span> pm.MutableData(<span class="st">"disease last year"</span>, df[<span class="st">"disease_last_year_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        deaths <span class="op">=</span> pm.MutableData(<span class="st">"deaths per 100k"</span>, df[<span class="st">"deaths_per100k"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># priors</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        intercept <span class="op">=</span> pm.Normal(<span class="st">"intercept"</span>, mu<span class="op">=</span><span class="dv">20</span>, sigma<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        month_mu <span class="op">=</span> pm.ZeroSumNormal(<span class="st">"month mu"</span>, sigma<span class="op">=</span><span class="dv">2</span>, dims<span class="op">=</span><span class="st">"month"</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> pm.Normal(<span class="st">"w"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="dv">3</span>, size<span class="op">=</span>B.shape[<span class="dv">1</span>], dims<span class="op">=</span><span class="st">"splines"</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        temp_lag1_coeff <span class="op">=</span> pm.Normal(<span class="st">"temp lag1 coeff"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        temp_lag2_coeff <span class="op">=</span> pm.Normal(<span class="st">"temp lag2 coeff"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        age_70_coeff <span class="op">=</span> pm.Normal(<span class="st">"age 70-75 coeff"</span>, mu<span class="op">=</span><span class="fl">0.3</span>, sigma<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        age_75_coeff <span class="op">=</span> pm.Normal(<span class="st">"age 75-80 coeff"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        age_80_coeff <span class="op">=</span> pm.Normal(<span class="st">"age 80+ coeff"</span>, mu<span class="op">=</span><span class="fl">0.7</span>, sigma<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        flu_75_lag1_coeff <span class="op">=</span> pm.Normal(<span class="st">"flu cases 75-79 per 100k lag1 coeff"</span>, mu<span class="op">=</span><span class="fl">0.1</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        flu_80_lag1_coeff <span class="op">=</span> pm.Normal(<span class="st">"flu cases 80+ per 100k lag1 coeff"</span>, mu<span class="op">=</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        flu_last_year_coeff <span class="op">=</span> pm.Normal(<span class="st">"flu last year coeff"</span>, mu<span class="op">=-</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        disease_75_coeff <span class="op">=</span> pm.Normal(<span class="st">"disease cases 75-79 per 100k coeff"</span>, mu<span class="op">=</span><span class="fl">0.1</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>        disease_80_coeff <span class="op">=</span> pm.Normal(<span class="st">"disease cases 80+ per 100k coeff"</span>, mu<span class="op">=</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        disease_last_year_coeff <span class="op">=</span> pm.Normal(<span class="st">"disease last year coeff"</span>, mu<span class="op">=-</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>        temp_flu_coeff <span class="op">=</span> pm.Normal(<span class="st">"temp:flu coeff"</span>, mu<span class="op">=</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>        flu_disease_coeff <span class="op">=</span> pm.Normal(<span class="st">"flu:disease coeff"</span>, mu<span class="op">=</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        disease_age_80_coeff <span class="op">=</span> pm.Normal(<span class="st">"disease:age80 coeff"</span>, mu<span class="op">=</span><span class="fl">0.2</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># model</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> pm.Deterministic(<span class="st">"mu"</span>, intercept <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                                    month_mu[month <span class="op">-</span> <span class="dv">1</span>] <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>                                    pm.math.dot(np.asarray(B, order<span class="op">=</span><span class="st">"F"</span>), w.T) <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>                                    temp_lag1_coeff <span class="op">*</span> temp_lag1 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>                                    temp_lag2_coeff <span class="op">*</span> temp_lag2 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>                                    age_70_coeff <span class="op">*</span> age_70 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>                                    age_75_coeff <span class="op">*</span> age_75 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>                                    age_80_coeff <span class="op">*</span> age_80 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>                                    flu_75_lag1_coeff <span class="op">*</span> flu_75_lag1 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>                                    flu_80_lag1_coeff <span class="op">*</span> flu_80_lag1 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>                                    flu_last_year_coeff <span class="op">*</span> flu_last_year <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>                                    disease_75_coeff <span class="op">*</span> disease_75 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>                                    disease_80_coeff <span class="op">*</span> disease_80 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>                                    disease_last_year_coeff <span class="op">*</span> disease_last_year <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>                                    temp_flu_coeff <span class="op">*</span> (pm.math.dot(np.asarray(B, order<span class="op">=</span><span class="st">"F"</span>), w.T) <span class="op">*</span> flu) <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>                                    flu_disease_coeff <span class="op">*</span> (flu <span class="op">*</span> disease) <span class="op">+</span> <span class="op">\</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                                    disease_age_80_coeff <span class="op">*</span> (disease <span class="op">*</span> age_80), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> pm.HalfNormal(<span class="st">"sigma"</span>, <span class="dv">1</span>)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># likelihood</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>        pm.Normal(<span class="st">"obs"</span>, mu<span class="op">=</span>mu, sigma<span class="op">=</span>sigma, observed<span class="op">=</span>deaths, dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With the factory function defining the model for given datasets is easy:</p>
<div class="cell" data-execution_count="78">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>train_model <span class="op">=</span> create_model(pre_df, post_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="prior-predictive-checks" class="level3">
<h3 class="anchored" data-anchor-id="prior-predictive-checks">Prior predictive checks</h3>
<p>As always in the <a href="https://arxiv.org/abs/2011.01808">Bayesian workflow</a> we begin by sampling from and plotting the prior predictive distribution.</p>
<p>Arguably, the results look pretty good. The model does not predict a negative number of deaths and the predicted range is neither too broad nor too narrow. Also the mean prior predictions are centered on the true values.</p>
<div class="cell" data-execution_count="79">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> train_model:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    idata <span class="op">=</span> pm.sample_prior_predictive(random_seed<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [age 70-75 coeff, age 75-80 coeff, age 80+ coeff, disease cases 75-79 per 100k coeff, disease cases 80+ per 100k coeff, disease last year coeff, disease:age80 coeff, flu cases 75-79 per 100k lag1 coeff, flu cases 80+ per 100k lag1 coeff, flu last year coeff, flu:disease coeff, intercept, month mu, obs, sigma, temp lag1 coeff, temp lag2 coeff, temp:flu coeff, w]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="80">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_pp(idata, pre_df):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    pp_quantiles <span class="op">=</span> idata.prior_predictive[<span class="st">"obs"</span>].quantile((<span class="fl">0.025</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.975</span>), dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)).transpose()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    _, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">4</span>), width_ratios<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">3</span>])</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> axs:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">"both"</span>, labelsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            ax.spines[spine].set_linewidth(<span class="fl">1.1</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> az.style.context(<span class="st">"arviz-plasmish"</span>):</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        az.plot_ppc(idata, group<span class="op">=</span><span class="st">"prior"</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>])</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].fill_between(pre_df.date, pp_quantiles.sel(quantile<span class="op">=</span>[<span class="fl">0.025</span>]).to_numpy().ravel(), pp_quantiles.sel(quantile<span class="op">=</span>[<span class="fl">0.975</span>]).to_numpy().ravel(), color<span class="op">=</span><span class="st">"#f5d1a4"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="st">"95% CI"</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].fill_between(pre_df.date, pp_quantiles.sel(quantile<span class="op">=</span>[<span class="fl">0.25</span>]).to_numpy().ravel(), pp_quantiles.sel(quantile<span class="op">=</span>[<span class="fl">0.75</span>]).to_numpy().ravel(), color<span class="op">=</span><span class="st">"#e6b170"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="st">"50% CI"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].plot(pre_df.date, pp_quantiles.sel(quantile<span class="op">=</span><span class="fl">0.5</span>), color<span class="op">=</span><span class="st">"#d18f3f"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="st">"mean"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].plot(pre_df.date, pre_df.deaths_per100k, color<span class="op">=</span><span class="st">"#55122f"</span>, label<span class="op">=</span><span class="st">"observed"</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].grid(<span class="va">False</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].set_xlim([pre_df.date.<span class="bu">min</span>() <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">50</span>), pre_df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">50</span>)])</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].legend(facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, loc<span class="op">=</span><span class="st">"upper left"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="81">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>plot_pp(idata, pre_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="inference" class="level3">
<h3 class="anchored" data-anchor-id="inference">Inference</h3>
<p>This means that we are ready to start sampling from our model. Keeping in mind that the functionality is still experimental (it wasn’t possible to use <code>pm.TruncatedNormal</code>, for instance), please relish the massive speed-up brought by sampling with <code>jax</code>/<code>numpyro</code>.</p>
<div class="cell" data-execution_count="82">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> train_model:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    idata.extend(pm.sampling_jax.sample_numpyro_nuts(draws<span class="op">=</span><span class="dv">2000</span>, tune<span class="op">=</span><span class="dv">2000</span>, random_seed<span class="op">=</span><span class="dv">1</span>, progressbar<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Compiling...
Compilation time =  0:00:06.275633
Sampling...
Sampling time =  0:00:13.159124
Transforming variables...
Transformation time =  0:00:00.783038</code></pre>
</div>
</div>
<p>Thanks to <code>az.summary()</code> and <code>az.plot_trace()</code> we can quickly see that the sampling ran very smoothly. Also the posterior distributions show no surprises.</p>
<div class="cell" data-execution_count="83">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>az.summary(idata, var_names<span class="op">=</span><span class="st">"~mu"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="83">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">intercept</td>
<td>19.544</td>
<td>0.398</td>
<td>18.738</td>
<td>20.240</td>
<td>0.009</td>
<td>0.006</td>
<td>2249.0</td>
<td>2943.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">w[0]</td>
<td>1.076</td>
<td>0.507</td>
<td>0.172</td>
<td>2.076</td>
<td>0.008</td>
<td>0.006</td>
<td>3785.0</td>
<td>4227.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">w[1]</td>
<td>2.010</td>
<td>0.447</td>
<td>1.193</td>
<td>2.872</td>
<td>0.009</td>
<td>0.006</td>
<td>2779.0</td>
<td>3425.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">w[2]</td>
<td>0.724</td>
<td>0.405</td>
<td>-0.023</td>
<td>1.505</td>
<td>0.008</td>
<td>0.006</td>
<td>2443.0</td>
<td>2986.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">w[3]</td>
<td>0.581</td>
<td>0.452</td>
<td>-0.264</td>
<td>1.438</td>
<td>0.009</td>
<td>0.007</td>
<td>2427.0</td>
<td>3400.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">w[4]</td>
<td>0.653</td>
<td>0.509</td>
<td>-0.333</td>
<td>1.562</td>
<td>0.010</td>
<td>0.007</td>
<td>2667.0</td>
<td>3728.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">w[5]</td>
<td>5.349</td>
<td>0.553</td>
<td>4.340</td>
<td>6.434</td>
<td>0.009</td>
<td>0.007</td>
<td>3527.0</td>
<td>4763.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">temp lag1 coeff</td>
<td>0.492</td>
<td>0.106</td>
<td>0.293</td>
<td>0.684</td>
<td>0.001</td>
<td>0.001</td>
<td>12613.0</td>
<td>5811.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">temp lag2 coeff</td>
<td>0.501</td>
<td>0.102</td>
<td>0.300</td>
<td>0.683</td>
<td>0.001</td>
<td>0.001</td>
<td>13429.0</td>
<td>6015.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">age 70-75 coeff</td>
<td>0.387</td>
<td>0.113</td>
<td>0.186</td>
<td>0.613</td>
<td>0.001</td>
<td>0.001</td>
<td>6576.0</td>
<td>6665.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">age 75-80 coeff</td>
<td>0.506</td>
<td>0.145</td>
<td>0.238</td>
<td>0.778</td>
<td>0.002</td>
<td>0.001</td>
<td>6176.0</td>
<td>6229.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">age 80+ coeff</td>
<td>0.969</td>
<td>0.138</td>
<td>0.706</td>
<td>1.220</td>
<td>0.001</td>
<td>0.001</td>
<td>8614.0</td>
<td>5790.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">flu cases 75-79 per 100k lag1 coeff</td>
<td>0.162</td>
<td>0.079</td>
<td>0.015</td>
<td>0.307</td>
<td>0.001</td>
<td>0.001</td>
<td>7674.0</td>
<td>6178.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">flu cases 80+ per 100k lag1 coeff</td>
<td>0.279</td>
<td>0.077</td>
<td>0.132</td>
<td>0.416</td>
<td>0.001</td>
<td>0.001</td>
<td>8396.0</td>
<td>6079.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">flu last year coeff</td>
<td>-0.144</td>
<td>0.043</td>
<td>-0.224</td>
<td>-0.062</td>
<td>0.000</td>
<td>0.000</td>
<td>8783.0</td>
<td>6722.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">disease cases 75-79 per 100k coeff</td>
<td>0.174</td>
<td>0.070</td>
<td>0.040</td>
<td>0.303</td>
<td>0.001</td>
<td>0.001</td>
<td>9268.0</td>
<td>6433.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">disease cases 80+ per 100k coeff</td>
<td>0.244</td>
<td>0.076</td>
<td>0.104</td>
<td>0.384</td>
<td>0.001</td>
<td>0.001</td>
<td>7683.0</td>
<td>6172.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">disease last year coeff</td>
<td>-0.144</td>
<td>0.043</td>
<td>-0.222</td>
<td>-0.059</td>
<td>0.000</td>
<td>0.000</td>
<td>8010.0</td>
<td>6819.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">temp:flu coeff</td>
<td>0.285</td>
<td>0.069</td>
<td>0.160</td>
<td>0.416</td>
<td>0.001</td>
<td>0.001</td>
<td>5223.0</td>
<td>4999.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">flu:disease coeff</td>
<td>0.165</td>
<td>0.066</td>
<td>0.040</td>
<td>0.285</td>
<td>0.001</td>
<td>0.001</td>
<td>6963.0</td>
<td>6000.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">disease:age80 coeff</td>
<td>0.275</td>
<td>0.066</td>
<td>0.159</td>
<td>0.409</td>
<td>0.001</td>
<td>0.000</td>
<td>12809.0</td>
<td>5590.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month mu[January]</td>
<td>0.532</td>
<td>0.166</td>
<td>0.212</td>
<td>0.838</td>
<td>0.003</td>
<td>0.002</td>
<td>4173.0</td>
<td>5451.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month mu[February]</td>
<td>0.660</td>
<td>0.182</td>
<td>0.312</td>
<td>0.994</td>
<td>0.003</td>
<td>0.002</td>
<td>4586.0</td>
<td>5818.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month mu[March]</td>
<td>0.753</td>
<td>0.153</td>
<td>0.461</td>
<td>1.033</td>
<td>0.002</td>
<td>0.001</td>
<td>5538.0</td>
<td>5651.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month mu[April]</td>
<td>0.437</td>
<td>0.120</td>
<td>0.214</td>
<td>0.664</td>
<td>0.001</td>
<td>0.001</td>
<td>12617.0</td>
<td>6414.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month mu[May]</td>
<td>-0.204</td>
<td>0.130</td>
<td>-0.446</td>
<td>0.039</td>
<td>0.002</td>
<td>0.001</td>
<td>6976.0</td>
<td>6428.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month mu[June]</td>
<td>-0.755</td>
<td>0.160</td>
<td>-1.056</td>
<td>-0.460</td>
<td>0.002</td>
<td>0.002</td>
<td>4442.0</td>
<td>5506.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month mu[July]</td>
<td>-0.978</td>
<td>0.176</td>
<td>-1.320</td>
<td>-0.657</td>
<td>0.003</td>
<td>0.002</td>
<td>4289.0</td>
<td>5386.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month mu[August]</td>
<td>-1.085</td>
<td>0.168</td>
<td>-1.406</td>
<td>-0.772</td>
<td>0.003</td>
<td>0.002</td>
<td>4407.0</td>
<td>5750.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month mu[September]</td>
<td>-0.608</td>
<td>0.139</td>
<td>-0.871</td>
<td>-0.343</td>
<td>0.002</td>
<td>0.001</td>
<td>5966.0</td>
<td>5894.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month mu[October]</td>
<td>0.286</td>
<td>0.126</td>
<td>0.042</td>
<td>0.508</td>
<td>0.001</td>
<td>0.001</td>
<td>10869.0</td>
<td>5972.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month mu[November]</td>
<td>0.323</td>
<td>0.143</td>
<td>0.063</td>
<td>0.605</td>
<td>0.002</td>
<td>0.001</td>
<td>7070.0</td>
<td>5881.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month mu[December]</td>
<td>0.640</td>
<td>0.152</td>
<td>0.373</td>
<td>0.944</td>
<td>0.002</td>
<td>0.001</td>
<td>5161.0</td>
<td>5700.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma</td>
<td>0.746</td>
<td>0.024</td>
<td>0.700</td>
<td>0.790</td>
<td>0.000</td>
<td>0.000</td>
<td>13475.0</td>
<td>5179.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="84">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> az.style.context(<span class="st">"arviz-darkgrid"</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    az.plot_trace(idata, var_names<span class="op">=</span><span class="st">"~mu"</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">24</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="85">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>az.plot_forest(idata.posterior, var_names<span class="op">=</span><span class="st">"month mu"</span>, textsize<span class="op">=</span><span class="dv">10</span>, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="posterior-predictive-checks" class="level3">
<h3 class="anchored" data-anchor-id="posterior-predictive-checks">Posterior predictive checks</h3>
<p>After checking the sampling process, we want to go a step further and check how well the model is able to retrodict the observed data. A reasonable model (with reasonable assumptions) should be able to simulate mortality data that is similar to the original observations in <code>pre_df</code>.</p>
<div class="cell" data-execution_count="86">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> train_model:</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    idata.extend(pm.sample_posterior_predictive(idata, random_seed<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="87">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_hdi_df(preds, hdi_prob_low, hdi_prob_high):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    hdi_dfs <span class="op">=</span> []</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> kind, prob <span class="kw">in</span> <span class="bu">zip</span>([<span class="st">"low"</span>, <span class="st">"high"</span>], [hdi_prob_low, hdi_prob_high]):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        hdi_df <span class="op">=</span> (az.hdi(preds, hdi_prob<span class="op">=</span>prob)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                    .to_dataframe()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                    .reset_index()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                    .pivot_table(index<span class="op">=</span><span class="st">"obs_id"</span>, columns<span class="op">=</span><span class="st">"hdi"</span>, values<span class="op">=</span><span class="st">"obs"</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                    .reset_index()</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                    .rename(columns<span class="op">=</span>{</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"lower"</span>: <span class="ss">f"</span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss">_lower"</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"higher"</span>: <span class="ss">f"</span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss">_higher"</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>                    }))</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        hdi_dfs.append(hdi_df)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    hdi_df <span class="op">=</span> pd.merge(left<span class="op">=</span>hdi_dfs[<span class="dv">0</span>], right<span class="op">=</span>hdi_dfs[<span class="dv">1</span>])</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    hdi_df[<span class="st">"pred_mean"</span>] <span class="op">=</span> preds.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>])</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hdi_df</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_retrodiction(idata, </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                      pre_df,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>                      years<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                      hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                      hdi_prob_high<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                      absolute<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    pre_hdi_df <span class="op">=</span> get_hdi_df(idata.posterior_predictive.obs, hdi_prob_low, hdi_prob_high)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    pre_cols <span class="op">=</span> (pre_df.iloc[pre_hdi_df.obs_id.values]</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                      .loc[:, [<span class="st">"population"</span>, <span class="st">"deaths_total"</span>, <span class="st">"deaths_per100k"</span>, <span class="st">"covid_deaths_per100k"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>, <span class="st">"date"</span>]]</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>                      .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.concat([pre_hdi_df, pre_cols], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    first_date <span class="op">=</span> df.date.<span class="bu">min</span>() <span class="cf">if</span> years <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> df.date.<span class="bu">max</span>() <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">365</span> <span class="op">*</span> (<span class="bu">len</span>(years)<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.loc[df.date <span class="op">&gt;=</span> first_date]</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    gs <span class="op">=</span> GridSpec(<span class="dv">2</span>, <span class="dv">2</span>, figure<span class="op">=</span>fig)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    ax0 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    ax0.set_title(<span class="ss">f"Posterior predictive distribution for </span><span class="sc">{</span>df<span class="sc">.</span>year<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>df<span class="sc">.</span>year<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">11</span>, pad<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    ax0.grid(axis<span class="op">=</span><span class="st">"y"</span>, color<span class="op">=</span><span class="st">"#f0f0f0"</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    ax0.xaxis.set_minor_locator(mdates.MonthLocator((<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">10</span>)))</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    ax0.xaxis.set_minor_formatter(mdates.DateFormatter(<span class="st">"%b"</span>))</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    ax0.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    ax0.yaxis.set_major_formatter(FuncFormatter(<span class="kw">lambda</span> x, _: <span class="bu">format</span>(<span class="bu">int</span>(x), <span class="st">','</span>)))</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    ax0.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"minor"</span>, labelbottom<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    ax0.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    ax0.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    ax0.set_xlim([first_date <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">10</span>), df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">50</span>)])</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    ax0.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>        ax0.fill_between(df.date, df.high_lower, df.high_higher, color<span class="op">=</span><span class="st">"#f0928b"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>        ax0.fill_between(df.date, df.low_lower, df.low_higher, color<span class="op">=</span><span class="st">"#d9746c"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>        ax0.plot(df.date, df.deaths_per100k, lw<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"#404040"</span>, label<span class="op">=</span><span class="st">"actual deaths"</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>        ax0.set_ylabel(<span class="st">"weekly deaths per 100,000 people"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>        ylim_min, ylim_max <span class="op">=</span> df.low_lower.<span class="bu">min</span>() <span class="op">*</span> <span class="fl">0.9</span>, df.deaths_per100k.<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.1</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>        ax0.set_ylim(ylim_min, ylim_max)</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>        mul <span class="op">=</span> df.population.div(<span class="dv">100_000</span>)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>        ax0.fill_between(df.date, df.high_lower.mul(mul), df.high_higher.mul(mul), color<span class="op">=</span><span class="st">"#f0928b"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>        ax0.fill_between(df.date, df.low_lower.mul(mul), df.low_higher.mul(mul), color<span class="op">=</span><span class="st">"#d9746c"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>        ax0.plot(df.date, df.deaths_total, lw<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"#404040"</span>, label<span class="op">=</span><span class="st">"actual deaths"</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>        ax0.set_ylabel(<span class="st">"weekly deaths"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>        ylim_min, ylim_max <span class="op">=</span> df.low_lower.mul(mul).<span class="bu">min</span>() <span class="op">*</span> <span class="fl">0.9</span>, df.deaths_total.<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.1</span></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>        ax0.set_ylim(ylim_min, ylim_max)</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>    ax0.legend(facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>    sns.lineplot(x<span class="op">=</span>pre_df.week, y<span class="op">=</span>pre_df.deaths_per100k, hue<span class="op">=</span>pre_df.year, ax<span class="op">=</span>ax1, lw<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">"Observed values"</span>)</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    handles1, labels1 <span class="op">=</span> ax1.get_legend_handles_labels()</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>    ax1.legend(handles<span class="op">=</span>handles1[::<span class="op">-</span><span class="dv">1</span>], labels<span class="op">=</span>labels1[::<span class="op">-</span><span class="dv">1</span>], facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>    sns.lineplot(x<span class="op">=</span>pre_df.week, y<span class="op">=</span>idata.posterior[<span class="st">"mu"</span>].mean(dim<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>]).to_numpy(), hue<span class="op">=</span>pre_df.year, ax<span class="op">=</span>ax2, lw<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">"Retrodiction"</span>)</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>    handles2, labels2 <span class="op">=</span> ax2.get_legend_handles_labels()</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    ax2.legend(handles<span class="op">=</span>handles2[::<span class="op">-</span><span class="dv">1</span>], labels<span class="op">=</span>labels2[::<span class="op">-</span><span class="dv">1</span>], facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> [ax1, ax2]:</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">16</span>, <span class="dv">33</span>)</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> [ax0, ax1, ax2]:</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>            ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>            ax.spines[spine].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>    fig.tight_layout()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="88">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plot_retrodiction(idata, pre_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>It’s probably fair to say that the model performs pretty well. Nonetheless, one issue catches the eye: the model struggles with the peaks of flu season.</p>
<p>Plotting the residuals confirms this suspicion. In more than a few years the model either under- or overestimates mortality at the peak of flu season. Because influenza waves tend to vary in their severity (e.g., due to the changing mix of strains in circulation and the match of the vaccines to these strains), this should probably be expected to some extent, though. Apart from that there is still some amount of variance left in the data that is not quite captured by the model. Given the data constraints this isn’t surprising, but still a finding to be aware of.</p>
<div class="cell" data-execution_count="89">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_residuals(idata, pre_df, hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>, hdi_prob_high<span class="op">=</span><span class="fl">0.95</span>):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> idata.observed_data.obs <span class="op">-</span> idata.posterior_predictive.obs</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    hdi_high <span class="op">=</span> az.hdi(residuals, hdi_prob<span class="op">=</span>hdi_prob_high)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    hdi_low <span class="op">=</span> az.hdi(residuals, hdi_prob<span class="op">=</span>hdi_prob_low)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    _, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Residuals"</span>, fontsize<span class="op">=</span><span class="dv">12</span>, pad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    ax.grid(axis<span class="op">=</span><span class="st">"y"</span>, color<span class="op">=</span><span class="st">"#f0f0f0"</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">1.</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    ax.fill_between(pre_df.date, hdi_high.sel(hdi<span class="op">=</span><span class="st">"lower"</span>).obs, hdi_high.sel(hdi<span class="op">=</span><span class="st">"higher"</span>).obs, color<span class="op">=</span><span class="st">"#a3c0ff"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    ax.fill_between(pre_df.date, hdi_low.sel(hdi<span class="op">=</span><span class="st">"lower"</span>).obs, hdi_low.sel(hdi<span class="op">=</span><span class="st">"higher"</span>).obs, color<span class="op">=</span><span class="st">"#7399eb"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_locator(mdates.MonthLocator((<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">10</span>)))</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_formatter(mdates.DateFormatter(<span class="st">"%b"</span>))</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_major_formatter(FuncFormatter(<span class="kw">lambda</span> x, _: <span class="bu">format</span>(<span class="bu">int</span>(x), <span class="st">','</span>)))</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"minor"</span>, labelbottom<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="fl">10.5</span>)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="fl">10.5</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim(pre_df.date.<span class="bu">min</span>() <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">10</span>), pre_df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">30</span>))</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="op">-</span><span class="dv">6</span>, <span class="dv">6</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="90">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>plot_residuals(idata, pre_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="counterfactual-inference" class="level3">
<h3 class="anchored" data-anchor-id="counterfactual-inference">Counterfactual inference</h3>
<p>Finally we can move on to the most interesting part: the counterfactual forecast of mortality. To do this, we make use of our factory function to get a new model conditioned on <code>post_df</code> (the model itself obviously stays the same), set the data accordingly, and run PyMC’s <code>sample_posterior_predictive()</code>.</p>
<div class="cell" data-execution_count="91">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pred_model <span class="op">=</span> create_model(pre_df, post_df, infer_post<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pred_model:</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    pm.set_data({</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month"</span>: post_df[<span class="st">"month"</span>].to_numpy(),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temp"</span>: post_df[<span class="st">"mean_temp_st"</span>].to_numpy(),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temp lag1"</span>: post_df[<span class="st">"min_lt0_lag1"</span>].to_numpy(),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temp lag2"</span>: post_df[<span class="st">"min_lt0_lag2"</span>].to_numpy(),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age 70-75"</span>: post_df[<span class="st">"pop_share_70_74_cnt"</span>].to_numpy(),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age 75-80"</span>: post_df[<span class="st">"pop_share_75_79_cnt"</span>].to_numpy(),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age 80+"</span>: post_df[<span class="st">"pop_share_gt80_cnt"</span>].to_numpy(),</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flu cases per 100k"</span>: post_df[<span class="st">"flu_cases_per100k_st"</span>].to_numpy(),</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flu cases age 75-79 per 100k lag1"</span>: post_df[<span class="st">"flu_cases_75_79_per100k_lag1_st"</span>].to_numpy(),</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flu cases age 80+ per 100k lag1"</span>: post_df[<span class="st">"flu_cases_gt80_per100k_lag1_st"</span>].to_numpy(),</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flu cases last year"</span>: post_df[<span class="st">"flu_last_year_st"</span>].to_numpy(),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"disease cases per 100k"</span>: post_df[<span class="st">"disease_cases_per100k_st"</span>].to_numpy(),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"disease cases age 75-79 per 100k"</span>: post_df[<span class="st">"disease_cases_75_79_per100k_st"</span>].to_numpy(),</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"disease cases age 80+ per 100k"</span>: post_df[<span class="st">"disease_cases_gt80_per100k_st"</span>].to_numpy(),</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"disease last year"</span>: post_df[<span class="st">"disease_last_year_st"</span>].to_numpy()</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    counterfactual <span class="op">=</span> pm.sample_posterior_predictive(</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        idata, var_names<span class="op">=</span>[<span class="st">"obs"</span>], random_seed<span class="op">=</span><span class="dv">1</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can plot the counterfactual estimate against the reported number of deaths. The colored regions represent the 50% and 95% credible intervals, respectively; the hatched rectangles emphasize the weeks with more (red) or less (yellow) severe federal response measures (i.e., lockdowns). Note that we include the estimate for some months prior to the rise of Covid-19 for better comparison (for these months it is of course the retrodiction, not the counterfactual).</p>
<div class="cell" data-execution_count="92">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_posterior_predictive(idata,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                             counterfactual,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                             pre_df,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                             post_df,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                             hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                             hdi_prob_high<span class="op">=</span><span class="fl">0.9</span>):</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    pre_hdi_df <span class="op">=</span> get_hdi_df(idata.posterior_predictive.obs, hdi_prob_low, hdi_prob_high)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    pre_cols <span class="op">=</span> (pre_df.iloc[pre_hdi_df.obs_id.values]</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                      .loc[:, [<span class="st">"population"</span>, <span class="st">"deaths_total"</span>, <span class="st">"deaths_per100k"</span>, <span class="st">"covid_deaths_per100k"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>, <span class="st">"date"</span>]]</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                      .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    pre_hdi_df <span class="op">=</span> pd.concat([pre_hdi_df, pre_cols], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    post_hdi_df <span class="op">=</span> get_hdi_df(counterfactual.posterior_predictive.obs, hdi_prob_low, hdi_prob_high)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    post_cols <span class="op">=</span> (post_df.iloc[post_hdi_df.obs_id.values]</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>                        .loc[:, [<span class="st">"population"</span>, <span class="st">"deaths_total"</span>, <span class="st">"deaths_per100k"</span>, <span class="st">"covid_deaths_per100k"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>, <span class="st">"date"</span>]]</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                        .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    post_hdi_df <span class="op">=</span> pd.concat([post_hdi_df, post_cols], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat([pre_hdi_df, post_hdi_df], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_posterior_predictive(idata, </span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>                              counterfactual, </span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>                              pre_df, </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>                              post_df,</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>                              years<span class="op">=</span>[<span class="dv">2018</span>, <span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>],</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>                              hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>                              hdi_prob_high<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>                              absolute<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>                              response_measures<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>                              dominant_voc<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> get_posterior_predictive(idata, counterfactual, pre_df, post_df, hdi_prob_low<span class="op">=</span>hdi_prob_low, hdi_prob_high<span class="op">=</span>hdi_prob_high)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    first_date <span class="op">=</span> df.date.<span class="bu">max</span>() <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">365</span> <span class="op">*</span> (<span class="bu">len</span>(years)<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.loc[df.date <span class="op">&gt;=</span> first_date]</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    first_month <span class="op">=</span> df.date.dt.month.iloc[<span class="dv">0</span>]</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    first_year <span class="op">=</span> df.date.dt.year.iloc[<span class="dv">0</span>]</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup figure</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Counterfactual estimate and actual deaths since </span><span class="sc">{</span>first_month<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>first_year<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="fl">13.5</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    ax.grid(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, color<span class="op">=</span><span class="st">"#e6e5e3"</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_locator(mdates.MonthLocator((<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">10</span>)))</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_formatter(mdates.DateFormatter(<span class="st">"%b"</span>))</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_major_formatter(FuncFormatter(<span class="kw">lambda</span> x, p: <span class="bu">format</span>(<span class="bu">int</span>(x), <span class="st">','</span>)))</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"minor"</span>, labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="fl">10.5</span>)</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim([first_date <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">10</span>), df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">150</span>)])</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="fl">10.5</span>)</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].date, df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].high_lower, df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].high_higher, color<span class="op">=</span><span class="st">"#e8e8e8"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].date, df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].low_lower, df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].low_higher, color<span class="op">=</span><span class="st">"#cfcfcf"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].date, df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].high_lower, df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].high_higher, color<span class="op">=</span><span class="st">"#f0928b"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].date, df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].low_lower, df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].low_higher, color<span class="op">=</span><span class="st">"#d9746c"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>        ax.plot(df.date, df.deaths_per100k, lw<span class="op">=</span><span class="st">"2"</span>, color<span class="op">=</span><span class="st">"#404040"</span>, label<span class="op">=</span><span class="st">"actual deaths"</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"weekly deaths per 100,000 people"</span>, fontsize<span class="op">=</span><span class="fl">11.5</span>)</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>        ylim_min, ylim_max <span class="op">=</span> df.low_lower.<span class="bu">min</span>() <span class="op">*</span> <span class="fl">0.9</span>, df.deaths_per100k.<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.1</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(ylim_min, ylim_max)</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>        mul_pre <span class="op">=</span> df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].population.div(<span class="dv">100_000</span>)</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>        mul_post <span class="op">=</span> df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].population.div(<span class="dv">100_000</span>)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].date, df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].high_lower.mul(mul_pre), df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].high_higher.mul(mul_pre), color<span class="op">=</span><span class="st">"#e8e8e8"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].date, df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].low_lower.mul(mul_pre), df[df.year <span class="op">&lt;</span> <span class="dv">2020</span>].low_higher.mul(mul_pre), color<span class="op">=</span><span class="st">"#cfcfcf"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].date, df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].high_lower.mul(mul_post), df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].high_higher.mul(mul_post), color<span class="op">=</span><span class="st">"#f0928b"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].date, df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].low_lower.mul(mul_post), df[df.year <span class="op">&gt;=</span> <span class="dv">2020</span>].low_higher.mul(mul_post), color<span class="op">=</span><span class="st">"#d9746c"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>        ax.plot(df.date, df.deaths_total, lw<span class="op">=</span><span class="st">"2"</span>, color<span class="op">=</span><span class="st">"#404040"</span>, label<span class="op">=</span><span class="st">"actual deaths"</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"weekly deaths"</span>, fontsize<span class="op">=</span><span class="fl">11.5</span>)</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>        ylim_min, ylim_max <span class="op">=</span> df.low_lower.mul(mul_post).<span class="bu">min</span>() <span class="op">*</span> <span class="fl">0.9</span>, df.deaths_total.<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.1</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(ylim_min, ylim_max)</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot response measures</span></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response_measures:</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">False</span>)</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> start, end, level <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">9</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">5</span>, day<span class="op">=</span><span class="dv">5</span>), <span class="dv">2</span>),</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">11</span>, day<span class="op">=</span><span class="dv">2</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">8</span>), <span class="dv">1</span>),</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">9</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">5</span>, day<span class="op">=</span><span class="dv">31</span>), <span class="dv">2</span>),</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">11</span>, day<span class="op">=</span><span class="dv">24</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">19</span>), <span class="dv">1</span>)]:</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>            level2color <span class="op">=</span> {</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>                <span class="dv">2</span>: <span class="st">"#d97914"</span>,</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>: <span class="st">"#fcdb44"</span></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> mdates.date2num(start)</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> mdates.date2num(end)</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> end <span class="op">-</span> start</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>            anchor <span class="op">=</span> (start, ylim_min)</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> (ylim_max <span class="op">-</span> ylim_min) <span class="op">*</span> <span class="fl">0.9</span></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>            rect <span class="op">=</span> patches.Rectangle(xy<span class="op">=</span>anchor, width<span class="op">=</span>width, height<span class="op">=</span>height, </span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>                                     color<span class="op">=</span>level2color[level], hatch<span class="op">=</span><span class="st">"//"</span>, </span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>                                     fill<span class="op">=</span><span class="va">None</span>, lw<span class="op">=</span><span class="dv">0</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>            ax.add_patch(rect)</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot dominant variants</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dominant_voc:</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">False</span>)</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>            line_ymax <span class="op">=</span> ylim_max <span class="op">*</span> <span class="fl">0.96</span></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>            arrow_y <span class="op">=</span> ylim_max <span class="op">*</span> <span class="fl">0.97</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>            text_y <span class="op">=</span> ylim_max <span class="op">*</span> <span class="fl">0.98</span></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>            line_ymax <span class="op">=</span> ylim_max <span class="op">*</span> <span class="fl">0.96</span></span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>            arrow_y <span class="op">=</span> ylim_max <span class="op">*</span> <span class="fl">0.97</span></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>            text_y <span class="op">=</span> ylim_max <span class="op">*</span> <span class="fl">0.98</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, desc, <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">1</span>, day<span class="op">=</span><span class="dv">27</span>), </span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"First case detected</span><span class="ch">\n</span><span class="st"> in Germany"</span>)]:</span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>            ax.vlines(t, ylim_min, line_ymax, color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>            ax.text(t, text_y <span class="op">*</span> <span class="fl">0.99</span>, s<span class="op">=</span>desc, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, desc <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">1</span>), <span class="st">"Alpha"</span>),</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">6</span>, day<span class="op">=</span><span class="dv">20</span>), <span class="st">"Delta"</span>),</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">20</span>), <span class="st">"BA. 1"</span>),</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">1</span>), <span class="st">"BA. 2"</span>),</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">6</span>, day<span class="op">=</span><span class="dv">10</span>), <span class="st">"BA. 5"</span>)]:</span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>            ax.vlines(t, ylim_min, line_ymax, color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> mdates.date2num(t <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">21</span>)) <span class="op">-</span> mdates.date2num(t)</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>            head_width <span class="op">=</span> <span class="fl">0.2</span> <span class="cf">if</span> <span class="kw">not</span> absolute <span class="cf">else</span> ylim_max <span class="op">*</span> <span class="fl">0.0075</span></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>            ax.arrow(t, arrow_y, </span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>                        dx<span class="op">=</span>width, dy<span class="op">=</span><span class="dv">0</span>, </span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>                        head_width<span class="op">=</span>head_width, </span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a>                        head_length<span class="op">=</span>width<span class="op">*</span><span class="fl">0.3</span>, </span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>                        lw<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a>            ax.text(t, text_y, s<span class="op">=</span>desc, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>    ax.legend(facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, loc<span class="op">=</span><span class="st">"upper right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="93">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>plot_posterior_predictive(idata, </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                          counterfactual, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                          pre_df, </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                          post_df, </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                          absolute<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                          response_measures<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>                          dominant_voc<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Sadly, Covid-19 appears to have caused a significant rise in mortality in many weeks and months of the pandemic. Let’s go through this chronologically: After the first (and in hindsight small) wave, the first summer of the pandemic saw low case numbers in Germany and therefore virtually no excess deaths (the one major spike was likely due to a heat wave and expected by the model). In the fall of 2020 case numbers started to rise again, culminating in the second wave which was associated with a high increase in mortality. This repeated itself in the fall and winter of 2021 when the third wave led to a significant number of excess deaths. Since then mortality still appears to follow anomalous patterns. For the last weeks of 2022, however, we should remind ourselves that the model probably significantly underestimates the severity of the flu wave. This wasn’t an issue during most months of the Covid-19 pandemic (since there were virtually no flu cases), but towards the end of the year 2022 flu cases actually soared for the first time since its beginning and the wave was described as quite severe (probably due to the waning immunity of the population).</p>
<p>Let’s change the perspective and look specifically at excess mortality since 2020:</p>
<div class="cell" data-execution_count="74">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_excess_deaths(counterfactual, year<span class="op">=</span><span class="va">None</span>, month<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> year <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        cf <span class="op">=</span> counterfactual.posterior_predictive.obs</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        deaths <span class="op">=</span> xr.DataArray(post_df[<span class="st">"deaths_per100k"</span>].to_numpy(), dims<span class="op">=</span>[<span class="st">"obs_id"</span>])</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> month <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>            cf <span class="op">=</span> counterfactual.posterior_predictive.obs.isel(obs_id<span class="op">=</span>post_df[post_df.year <span class="op">==</span> year].index)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>            deaths <span class="op">=</span> xr.DataArray(post_df[post_df.year <span class="op">==</span> year][<span class="st">"deaths_per100k"</span>].to_numpy(), dims<span class="op">=</span>[<span class="st">"obs_id"</span>])</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>            cf <span class="op">=</span> counterfactual.posterior_predictive.obs.isel(obs_id<span class="op">=</span>post_df[(post_df.year <span class="op">==</span> year) <span class="op">&amp;</span> (post_df.month <span class="op">==</span> month)].index)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>            deaths <span class="op">=</span> xr.DataArray(post_df[(post_df.year <span class="op">==</span> year) <span class="op">&amp;</span> (post_df.month <span class="op">==</span> month)][<span class="st">"deaths_per100k"</span>].to_numpy(), dims<span class="op">=</span>[<span class="st">"obs_id"</span>])</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    excess_deaths <span class="op">=</span> deaths <span class="op">-</span> cf</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    cum_excess <span class="op">=</span> excess_deaths.cumsum(dim<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess_deaths.transpose(..., <span class="st">"obs_id"</span>), cum_excess.transpose(..., <span class="st">"obs_id"</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cf_hdi_df(preds, hdi_prob_low, hdi_prob_high):</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    hdi_dfs <span class="op">=</span> []</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> kind, prob <span class="kw">in</span> <span class="bu">zip</span>([<span class="st">"low"</span>, <span class="st">"high"</span>], [hdi_prob_low, hdi_prob_high]):</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        hdi_df <span class="op">=</span> (az.hdi(preds, hdi_prob<span class="op">=</span>prob)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>                    .to_dataframe()</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>                    .reset_index()</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>                    .pivot_table(index<span class="op">=</span><span class="st">"obs_id"</span>, columns<span class="op">=</span><span class="st">"hdi"</span>, values<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>                    .reset_index()</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>                    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>                    .rename(columns<span class="op">=</span>{</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"lower"</span>: <span class="ss">f"</span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss">_lower"</span>,</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"higher"</span>: <span class="ss">f"</span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss">_higher"</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>                    }))</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        hdi_dfs.append(hdi_df)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    hdi_df <span class="op">=</span> pd.merge(left<span class="op">=</span>hdi_dfs[<span class="dv">0</span>], right<span class="op">=</span>hdi_dfs[<span class="dv">1</span>])</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    hdi_df[<span class="st">"pred_mean"</span>] <span class="op">=</span> preds.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>])</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    post_cols <span class="op">=</span> (post_df.iloc[hdi_df.obs_id.values]</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>                        .loc[:, [<span class="st">"population"</span>, <span class="st">"deaths_total"</span>, <span class="st">"deaths_per100k"</span>, <span class="st">"covid_deaths_per100k"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>, <span class="st">"date"</span>]]</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>                        .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    hdi_df <span class="op">=</span> pd.concat([hdi_df, post_cols], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hdi_df</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_excess_deaths(counterfactual,</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>                       hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>                       hdi_prob_high<span class="op">=</span><span class="fl">0.95</span>, </span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>                       absolute<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    excess_deaths, cumsum <span class="op">=</span> get_excess_deaths(counterfactual)</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, bottom<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_linewidth(<span class="fl">1.2</span>)</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Estimated excess deaths in Germany since 01/20"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>    excess_df <span class="op">=</span> get_cf_hdi_df(excess_deaths, hdi_prob_low, hdi_prob_high)</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    xlim_min <span class="op">=</span> pd.Timestamp(year<span class="op">=</span><span class="dv">2019</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>        excess_ylim_min <span class="op">=</span> excess_df.high_lower.<span class="bu">min</span>() <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>        excess_ylim_max <span class="op">=</span> excess_df.high_higher.<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>        ax.plot(excess_df.date, excess_df.covid_deaths_per100k, lw<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"#44454a"</span>, label<span class="op">=</span><span class="st">"official</span><span class="ch">\n</span><span class="st">C19 deaths"</span>)</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(excess_df.date, excess_df.high_lower, excess_df.high_higher, color<span class="op">=</span><span class="st">"#f0928b"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(excess_df.date, excess_df.low_lower, excess_df.low_higher, color<span class="op">=</span><span class="st">"#d9746c"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>        ax.hlines(y<span class="op">=</span><span class="dv">0</span>, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">1.5</span>, ls<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"weekly excess deaths per 100,000 people"</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: </span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>        mul <span class="op">=</span> excess_df.population <span class="op">/</span> <span class="dv">100_000</span></span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>        excess_ylim_min <span class="op">=</span> excess_df.high_lower.mul(mul).<span class="bu">min</span>() <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>        excess_ylim_max <span class="op">=</span> excess_df.high_higher.mul(mul).<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(excess_df.date, excess_df.high_lower.mul(mul), excess_df.high_higher.mul(mul), color<span class="op">=</span><span class="st">"#f0928b"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(excess_df.date, excess_df.low_lower.mul(mul), excess_df.low_higher.mul(mul), color<span class="op">=</span><span class="st">"#d9746c"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>        ax.plot(excess_df.date, excess_df.covid_deaths_per100k.mul(mul), lw<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"#44454a"</span>, label<span class="op">=</span><span class="st">"official</span><span class="ch">\n</span><span class="st">C19 deaths"</span>)</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>        ax.hlines(y<span class="op">=</span><span class="dv">0</span>, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">1.5</span>, ls<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"weekly excess deaths"</span>, fontsize<span class="op">=</span><span class="dv">11</span>, labelpad<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> ax.get_yticks()[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>        ax.hlines(y<span class="op">=</span>y, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">"#a1a1a1"</span>, zorder<span class="op">=-</span><span class="dv">10</span>)</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_major_formatter(FuncFormatter(<span class="kw">lambda</span> x, p: <span class="bu">format</span>(<span class="bu">int</span>(x), <span class="st">','</span>)))</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>    ax.legend(facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_locator(mdates.MonthLocator(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)))</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_formatter(mdates.DateFormatter(<span class="st">"%b"</span>))</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"minor"</span>, labelsize<span class="op">=</span><span class="fl">9.5</span>)</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="fl">11.5</span>)</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim([pd.Timestamp(year<span class="op">=</span><span class="dv">2019</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">10</span>), post_df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">30</span>)])</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>    plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="75">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>plot_excess_deaths(counterfactual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can see that the model’s predictions of excess mortality generally follow the official count of deaths that were “associated with Covid-19” quite closely. However, in weeks with many Covid-19 deaths (around the peaks of the infection waves) actual mortality figures appear to have been higher than what was officially recorded. In these weeks, many hospitals were running at full capacity, so Covid-19 may have been (at least in part) the indirect rather than the direct cause of these additional deaths. In any case, we can probably conclude that excess mortality due to Covid-19 hasn’t been significantly overestimated in Germany.</p>
</section>
</section>
<section id="the-hierarchical-model" class="level2">
<h2 class="anchored" data-anchor-id="the-hierarchical-model">The Hierarchical Model</h2>
<p>Until now we have looked at the aggregated data for Germany, but the title of this blog post promised a hierarchical model. So let’s build a hierarchical model for estimating excess mortality in the German states! Why a hierarchical model? The alternatives would be either a complete pooled model, which assumes that one model is appropriate for estimating mortality in all states, or an unpooled model, which assumes that a model for one state doesn’t contain information that is relevant for other states. Given that the German states are quite similar but certainly differ to some degree in relevant aspects (population density, access to and quality of health care, geography, etc.), a hierarchical model is the better choice.</p>
<div class="cell" data-execution_count="95">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize_by_state(pre_df, post_df, feature):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    pre_st <span class="op">=</span> np.zeros(pre_df.shape[<span class="dv">0</span>])</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    post_st <span class="op">=</span> np.zeros(post_df.shape[<span class="dv">0</span>])</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> state <span class="kw">in</span> df[<span class="st">"state"</span>].unique():</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        pre_mask <span class="op">=</span> pre_df[<span class="st">"state"</span>] <span class="op">==</span> state</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        post_mask <span class="op">=</span> post_df[<span class="st">"state"</span>] <span class="op">==</span> state</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        pre_vals <span class="op">=</span> pre_df.loc[pre_mask, feature]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        post_vals <span class="op">=</span> post_df.loc[post_mask, feature]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        ss <span class="op">=</span> StandardScaler()</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        ss.fit(pre_vals.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        pre_st[pre_mask] <span class="op">=</span> ss.transform(pre_vals.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).ravel()</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        post_st[post_mask] <span class="op">=</span> ss.transform(post_vals.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).ravel()</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pre_st, post_st</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_datasets(df):</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"is_pre_covid"</span>] <span class="op">=</span> df[<span class="st">"year"</span>] <span class="op">&lt;</span> <span class="dv">2020</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.loc[df.year.isin(<span class="bu">range</span>(<span class="dv">2010</span>, <span class="dv">2023</span>))]</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    pre_df <span class="op">=</span> df[df[<span class="st">"is_pre_covid"</span>]].copy()</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    post_df <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">"is_pre_covid"</span>]].copy()</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> [<span class="st">"mean_temp"</span>, </span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"pop_share_70"</span>,</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"pop_share_75"</span>,</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"pop_share_80"</span>,</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_per100k"</span>, </span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_per100k_lag1"</span>,</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_75_per100k"</span>,</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_75_per100k_lag1"</span>,</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_80_per100k"</span>,</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_80_per100k_lag1"</span>,</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"flu_cases_last_year"</span>,</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_per100k"</span>,</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_per100k_lag1"</span>,</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_75_per100k"</span>,</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_75_per100k_lag1"</span>,</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_80_per100k"</span>,</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_80_per100k_lag1"</span>,</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"disease_cases_last_year"</span>]:</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>        pre_df[<span class="ss">f"</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">_st"</span>], post_df[<span class="ss">f"</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">_st"</span>] <span class="op">=</span>  standardize_by_state(pre_df, post_df, feature)</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pre_df, post_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="96">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> Path(<span class="st">"../data/final/states.ftr"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>map_path <span class="op">=</span> Path(<span class="st">"../data/final/maps"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>abbr_path <span class="op">=</span> Path(<span class="st">"../data/raw/states/abbr2name.pkl"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(abbr_path, <span class="st">"rb"</span>) <span class="im">as</span> f:</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    abbr2name <span class="op">=</span> pickle.load(f)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_feather(data_path)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>pre_df, post_df <span class="op">=</span> create_datasets(df.copy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s have a quick look at the data again (no worries, we’ll keep this much more concise).</p>
<p>For example, let’s plot the mortality figures of Bavaria, the state with the highest GDP per capita (at least when we ignore the city-states of Bremen and Hamburg), and Mecklenburg-Western Pomerania, the state with the lowest GDP per capita. As we can see, the difference between states can be quite distinct. (There are many reasons for this; the different age structure probably being the most important one.)</p>
<div class="cell" data-execution_count="98">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>pre_by, post_by <span class="op">=</span> pre_df[pre_df.state <span class="op">==</span> <span class="st">"by"</span>].copy(), post_df[post_df.state <span class="op">==</span> <span class="st">"by"</span>].copy()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>pre_mv, post_mv <span class="op">=</span> pre_df[pre_df.state <span class="op">==</span> <span class="st">"mv"</span>].copy(), post_df[post_df.state <span class="op">==</span> <span class="st">"mv"</span>].copy()</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> get_plot(ylabel<span class="op">=</span><span class="st">"weekly deaths per 100,000 people"</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>ax.plot(pre_by.date, pre_by.deaths_per100k, color<span class="op">=</span><span class="st">"#5b62ba"</span>, zorder<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Bavaria"</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>ax.plot(post_by.date, post_by.deaths_per100k, color<span class="op">=</span><span class="st">"#5b62ba"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>ax.plot(pre_mv.date, pre_mv.deaths_per100k, color<span class="op">=</span><span class="st">"#715394"</span>, zorder<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Mecklenburg-Vorpommern"</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>ax.plot(post_mv.date, post_mv.deaths_per100k, color<span class="op">=</span><span class="st">"#715394"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlim([pre_df.date.<span class="bu">min</span>() <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">50</span>), post_df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">100</span>)])</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>ax.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-33-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s continue with the definition of the model. The key idea in hierarchical models is that groups don’t share a fixed parameter but a <em>hyperprior distribution</em> which describes the distribution of the prior’s parameters. Thus, each group has its own prior parameters which are drawn from a common hyperprior distribution. If you need more information, the PyMC documentation includes a nice <a href="https://www.pymc.io/projects/examples/en/latest/case_studies/multilevel_modeling.html">primer</a> on hierarchical Bayesian models and a handful of <a href="https://www.pymc.io/projects/examples/en/latest/blog/tag/hierarchical-model.html">examples</a> for different topics. For more info regarding model reparameterization see <a href="https://twiecki.io/blog/2017/02/08/bayesian-hierchical-non-centered/">here</a> and <a href="https://num.pyro.ai/en/latest/tutorials/bad_posterior_geometry.html">here</a>.</p>
<div class="cell" data-execution_count="99">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model(pre_df, post_df, infer_post<span class="op">=</span><span class="va">False</span>, num_knots<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the dataset</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pre_df <span class="cf">if</span> <span class="kw">not</span> infer_post <span class="cf">else</span> post_df</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the design matrix for the splines</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    knot_list <span class="op">=</span> np.quantile(pre_df.mean_temp, np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, num_knots))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> dmatrix(<span class="st">"0 + bs(mean_temp, knots=knots, degree=2, include_intercept=True)"</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"mean_temp"</span>: df.mean_temp.values, <span class="st">"knots"</span>: knot_list[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]})</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the model coords</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    state_idxs, states <span class="op">=</span> pd.factorize(df[<span class="st">"state"</span>])</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    month_strings <span class="op">=</span> calendar.month_name[<span class="dv">1</span>:]</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    coords <span class="op">=</span> {</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month"</span>: month_strings,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"state"</span>: states,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"splines"</span>: np.arange(B.shape[<span class="dv">1</span>])</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the model</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords) <span class="im">as</span> model:</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># observed data</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        state_idx <span class="op">=</span> pm.MutableData(<span class="st">"state_idx"</span>, state_idxs, dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        time <span class="op">=</span> pm.MutableData(<span class="st">"time"</span>, df[<span class="st">"t"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> pm.MutableData(<span class="st">"month"</span>, df[<span class="st">"month"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        mean_temp <span class="op">=</span> pm.MutableData(<span class="st">"mean temp"</span>, df[<span class="st">"mean_temp_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        temp_lag1 <span class="op">=</span> pm.MutableData(<span class="st">"temp lag1"</span>, df[<span class="st">"min_lt0_lag1"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        temp_lag2 <span class="op">=</span> pm.MutableData(<span class="st">"temp lag2"</span>, df[<span class="st">"min_lt0_lag2"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        age_70 <span class="op">=</span> pm.MutableData(<span class="st">"age 70-75"</span>, df[<span class="st">"pop_share_70_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        age_75 <span class="op">=</span> pm.MutableData(<span class="st">"age 75-80"</span>, df[<span class="st">"pop_share_75_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>        age_80 <span class="op">=</span> pm.MutableData(<span class="st">"age 80+"</span>, df[<span class="st">"pop_share_80_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>        flu_75_lag1 <span class="op">=</span> pm.MutableData(<span class="st">"flu cases per 100k age 75-79 lag1"</span>, df[<span class="st">"flu_cases_75_per100k_lag1_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>        flu_80_lag1 <span class="op">=</span> pm.MutableData(<span class="st">"flu cases per 100k age 80+ lag1"</span>, df[<span class="st">"flu_cases_80_per100k_lag1_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        disease_75 <span class="op">=</span> pm.MutableData(<span class="st">"disease cases per 100k age 75-79"</span>, df[<span class="st">"disease_cases_75_per100k_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        disease_80 <span class="op">=</span> pm.MutableData(<span class="st">"disease cases per 100k age 80+"</span>, df[<span class="st">"disease_cases_80_per100k_st"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        deaths <span class="op">=</span> pm.MutableData(<span class="st">"deaths per 100k"</span>, df[<span class="st">"deaths_per100k"</span>].to_numpy(), dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># hyperpriors</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>        intercept_mu <span class="op">=</span> pm.Normal(<span class="st">"intercept_mu"</span>, mu<span class="op">=</span><span class="fl">22.</span>, sigma<span class="op">=</span><span class="fl">2.</span>)</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>        intercept_sigma <span class="op">=</span> pm.HalfNormal(<span class="st">"intercept sigma"</span>, <span class="fl">1.</span>)</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>        temp_lag1_mu <span class="op">=</span> pm.Normal(<span class="st">"temp lag1 mu"</span>, mu<span class="op">=</span><span class="fl">1.</span>, sigma<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>        temp_lag1_sigma <span class="op">=</span> pm.Normal(<span class="st">"temp lag1 sigma"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>        temp_lag2_mu <span class="op">=</span> pm.Normal(<span class="st">"temp lag2 mu"</span>, mu<span class="op">=</span><span class="fl">1.</span>, sigma<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>        temp_lag2_sigma <span class="op">=</span> pm.Normal(<span class="st">"temp lag2 sigma"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>        age_70_mu <span class="op">=</span> pm.Normal(<span class="st">"age 70-75 mu"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.25</span>)</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>        age_70_sigma <span class="op">=</span> pm.Normal(<span class="st">"age 70-75 sigma"</span>, mu<span class="op">=</span><span class="fl">1.</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>        age_75_mu <span class="op">=</span> pm.Normal(<span class="st">"age 75-80 mu"</span>, mu<span class="op">=</span><span class="fl">0.75</span>, sigma<span class="op">=</span><span class="fl">0.25</span>)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>        age_75_sigma <span class="op">=</span> pm.Normal(<span class="st">"age 75-80 sigma"</span>, mu<span class="op">=</span><span class="fl">1.</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        age_80_mu <span class="op">=</span> pm.Normal(<span class="st">"age 80+ mu"</span>, mu<span class="op">=</span><span class="fl">1.25</span>, sigma<span class="op">=</span><span class="fl">0.25</span>)</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>        age_80_sigma <span class="op">=</span> pm.Normal(<span class="st">"age 80+ sigma"</span>, mu<span class="op">=</span><span class="fl">1.</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>        flu_75_lag1_mu <span class="op">=</span> pm.Normal(<span class="st">"flu cases per 100k age 75-79 lag1 mu"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>        flu_75_lag1_sigma <span class="op">=</span> pm.Normal(<span class="st">"flu cases per 100k age 75-79 lag1 sigma"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>        flu_80_lag1_mu <span class="op">=</span> pm.Normal(<span class="st">"flu cases per 100k age 80+ lag1 mu"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>        flu_80_lag1_sigma <span class="op">=</span> pm.Normal(<span class="st">"flu cases per 100k age 80+ lag1 sigma"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>        disease_75_mu <span class="op">=</span> pm.Normal(<span class="st">"disease cases per 100k age 75-79 mu"</span>, mu<span class="op">=</span><span class="fl">0.75</span>, sigma<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>        disease_75_sigma <span class="op">=</span> pm.Normal(<span class="st">"disease cases per 100k age 75-79 sigma"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>        disease_80_mu <span class="op">=</span> pm.Normal(<span class="st">"disease cases per 100k age 80+ mu"</span>, mu<span class="op">=</span><span class="fl">0.75</span>, sigma<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        disease_80_sigma <span class="op">=</span> pm.Normal(<span class="st">"disease cases per 100k age 80+ sigma"</span>, mu<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># priors</span></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>        intercept_offset <span class="op">=</span> pm.Normal(<span class="st">"intercept offset"</span>, mu<span class="op">=</span><span class="fl">0.</span>, sigma<span class="op">=</span><span class="fl">1.</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>        intercept <span class="op">=</span> pm.Deterministic(<span class="st">"intercept"</span>, intercept_mu <span class="op">+</span> intercept_offset <span class="op">*</span> intercept_sigma)</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>        month_mu <span class="op">=</span> pm.ZeroSumNormal(<span class="st">"month mu"</span>, sigma<span class="op">=</span><span class="dv">4</span>, dims<span class="op">=</span><span class="st">"month"</span>)</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>        temp_lag1_offset <span class="op">=</span> pm.Normal(<span class="st">"temp lag1 offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>        temp_lag1_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"temp lag1 coeff"</span>, temp_lag1_mu <span class="op">+</span> temp_lag1_offset <span class="op">*</span> temp_lag1_sigma)</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>        temp_lag2_offset <span class="op">=</span> pm.Normal(<span class="st">"temp lag2 offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>        temp_lag2_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"temp lag2 coeff"</span>, temp_lag2_mu <span class="op">+</span> temp_lag2_offset <span class="op">*</span> temp_lag2_sigma)</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>        age_70_offset <span class="op">=</span> pm.Normal(<span class="st">"age 70-75 offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>        age_70_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"age 70-75 coeff"</span>, age_70_mu <span class="op">+</span> age_70_offset <span class="op">*</span> age_70_sigma)</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>        age_75_offset <span class="op">=</span> pm.Normal(<span class="st">"age 75-80 offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>        age_75_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"age 75-80 coeff"</span>, age_75_mu <span class="op">+</span> age_75_offset <span class="op">*</span> age_75_sigma)</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>        age_80_offset <span class="op">=</span> pm.Normal(<span class="st">"age 80+ offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>        age_80_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"age 80+ coeff"</span>, age_80_mu <span class="op">+</span> age_80_offset <span class="op">*</span> age_80_sigma)</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>        flu_75_lag1_offset <span class="op">=</span> pm.Normal(<span class="st">"flu cases per 100k age 75-79 lag1 offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>        flu_75_lag1_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"flu cases per 100k age 75-79 lag1 coeff"</span>, flu_75_lag1_mu <span class="op">+</span> flu_75_lag1_offset <span class="op">*</span> flu_75_lag1_sigma)</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>        flu_80_lag1_offset <span class="op">=</span> pm.Normal(<span class="st">"flu cases per 100k age 80+ lag1 offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>        flu_80_lag1_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"flu cases per 100k age 80+ lag1 coeff"</span>, flu_80_lag1_mu <span class="op">+</span> flu_80_lag1_offset <span class="op">*</span> flu_80_lag1_sigma)</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>        disease_75_offset <span class="op">=</span> pm.Normal(<span class="st">"disease cases per 100k age 75-79 offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>        disease_75_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"disease cases per 100k age 75-79 coeff"</span>, disease_75_mu <span class="op">+</span> disease_75_offset <span class="op">*</span> disease_75_sigma)</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>        disease_80_offset <span class="op">=</span> pm.Normal(<span class="st">"disease cases per 100k age 80+ offset"</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">0.5</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>        disease_80_coeff <span class="op">=</span> pm.Deterministic(<span class="st">"disease cases per 100k age 80+ coeff"</span>, disease_80_mu <span class="op">+</span> disease_80_offset <span class="op">*</span> disease_80_sigma)</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># temperature splines</span></span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>        sd_dist <span class="op">=</span> pm.Gamma.dist(<span class="dv">2</span>, <span class="fl">0.5</span>, shape<span class="op">=</span>B.shape[<span class="dv">1</span>])</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>        chol, corr, stds <span class="op">=</span> pm.LKJCholeskyCov(</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol"</span>, eta<span class="op">=</span><span class="dv">2</span>, n<span class="op">=</span>B.shape[<span class="dv">1</span>], sd_dist<span class="op">=</span>sd_dist, compute_corr<span class="op">=</span><span class="va">True</span></span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>        cov <span class="op">=</span> pm.Deterministic(<span class="st">"cov"</span>, chol.dot(chol.T))</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>        w_mu <span class="op">=</span> pm.Normal(<span class="st">"w mu"</span>, mu<span class="op">=</span><span class="fl">0.</span>, sigma<span class="op">=</span><span class="fl">1.</span>, shape<span class="op">=</span>(B.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>        w_delta <span class="op">=</span> pm.Normal(<span class="st">"w_delta"</span>, mu<span class="op">=</span><span class="fl">0.</span>, sigma<span class="op">=</span><span class="fl">1.</span>, shape<span class="op">=</span>(B.shape[<span class="dv">1</span>], <span class="bu">len</span>(states)))</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> pm.Deterministic(<span class="st">"w"</span>, w_mu <span class="op">+</span> at.dot(chol, w_delta))</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>        sp <span class="op">=</span> []</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(states)):</span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>            sp.append(at.dot(np.asarray(B[state_idxs <span class="op">==</span> i, :]), w[:, i]).reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># model</span></span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> pm.Deterministic(<span class="st">"mu"</span>, intercept[state_idx] <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>                                    month_mu[month <span class="op">-</span> <span class="dv">1</span>] <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>                                    at.vertical_stack(<span class="op">*</span>sp).squeeze() <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>                                    temp_lag1_coeff[state_idx] <span class="op">*</span> temp_lag1 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>                                    temp_lag2_coeff[state_idx] <span class="op">*</span> temp_lag2 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>                                    age_70_coeff[state_idx] <span class="op">*</span> age_70 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>                                    age_75_coeff[state_idx] <span class="op">*</span> age_75 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>                                    age_80_coeff[state_idx] <span class="op">*</span> age_80 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>                                    flu_75_lag1_coeff[state_idx] <span class="op">*</span> flu_75_lag1 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>                                    flu_80_lag1_coeff[state_idx] <span class="op">*</span> flu_80_lag1 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>                                    disease_75_coeff[state_idx] <span class="op">*</span> disease_75 <span class="op">+</span> <span class="op">\</span></span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>                                    disease_80_coeff[state_idx] <span class="op">*</span> disease_80, dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>                                    </span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> pm.HalfNormal(<span class="st">"sigma"</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">"state"</span>)</span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># likelihood</span></span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>        pm.Normal(<span class="st">"obs"</span>, mu<span class="op">=</span>mu, sigma<span class="op">=</span>sigma[state_idx], observed<span class="op">=</span>deaths, dims<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="100">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>train_model <span class="op">=</span> create_model(pre_df, post_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="101">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> train_model:</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    idata <span class="op">=</span> pm.sample_prior_predictive(random_seed<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [age 70-75 mu, age 70-75 offset, age 70-75 sigma, age 75-80 mu, age 75-80 offset, age 75-80 sigma, age 80+ mu, age 80+ offset, age 80+ sigma, chol, disease cases per 100k age 75-79 mu, disease cases per 100k age 75-79 offset, disease cases per 100k age 75-79 sigma, disease cases per 100k age 80+ mu, disease cases per 100k age 80+ offset, disease cases per 100k age 80+ sigma, flu cases per 100k age 75-79 lag1 mu, flu cases per 100k age 75-79 lag1 offset, flu cases per 100k age 75-79 lag1 sigma, flu cases per 100k age 80+ lag1 mu, flu cases per 100k age 80+ lag1 offset, flu cases per 100k age 80+ lag1 sigma, intercept offset, intercept sigma, intercept_mu, month mu, obs, sigma, temp lag1 mu, temp lag1 offset, temp lag1 sigma, temp lag2 mu, temp lag2 offset, temp lag2 sigma, w mu, w_delta]</code></pre>
</div>
</div>
<p>The prior predictive plot looks solid (for brevity we only look at one plot for all 16 states):</p>
<div class="cell" data-execution_count="103">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_pp(idata, pre_df):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    pp_quantiles <span class="op">=</span> idata.prior_predictive[<span class="st">"obs"</span>].quantile((<span class="fl">0.025</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.975</span>), dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)).transpose()</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    _, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">4</span>), width_ratios<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">3</span>])</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> axs:</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">"both"</span>, labelsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>            ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>            ax.spines[spine].set_linewidth(<span class="fl">1.1</span>)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> az.style.context(<span class="st">"arviz-plasmish"</span>):</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        az.plot_ppc(idata, group<span class="op">=</span><span class="st">"prior"</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>])</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].fill_between(pre_df.date, pp_quantiles.sel(quantile<span class="op">=</span>[<span class="fl">0.025</span>]).to_numpy().ravel(), pp_quantiles.sel(quantile<span class="op">=</span>[<span class="fl">0.975</span>]).to_numpy().ravel(), color<span class="op">=</span><span class="st">"#f5d1a4"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="st">"95% CI"</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].fill_between(pre_df.date, pp_quantiles.sel(quantile<span class="op">=</span>[<span class="fl">0.25</span>]).to_numpy().ravel(), pp_quantiles.sel(quantile<span class="op">=</span>[<span class="fl">0.75</span>]).to_numpy().ravel(), color<span class="op">=</span><span class="st">"#e6b170"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="st">"50% CI"</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].plot(pre_df.date, pp_quantiles.sel(quantile<span class="op">=</span><span class="fl">0.5</span>), color<span class="op">=</span><span class="st">"#d18f3f"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="st">"mean"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].scatter(pre_df.date, pre_df.deaths_per100k, color<span class="op">=</span><span class="st">"#55122f"</span>, label<span class="op">=</span><span class="st">"observed"</span>, zorder<span class="op">=</span><span class="dv">4</span>, s<span class="op">=</span><span class="fl">0.25</span>)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].grid(<span class="va">False</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].set_xlim([pre_df.date.<span class="bu">min</span>() <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">50</span>), pre_df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">50</span>)])</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].legend(facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, loc<span class="op">=</span><span class="st">"upper left"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="104">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>plot_pp(idata, pre_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-38-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="105">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> train_model:</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    idata.extend(pm.sampling_jax.sample_numpyro_nuts(draws<span class="op">=</span><span class="dv">1000</span>, tune<span class="op">=</span><span class="dv">1000</span>, random_seed<span class="op">=</span><span class="dv">1</span>, progressbar<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Compiling...
Compilation time =  0:00:18.643953
Sampling...
Sampling time =  0:05:17.676316
Transforming variables...
Transformation time =  0:00:10.056034</code></pre>
</div>
</div>
<p>And the traces look okay, too:</p>
<div class="cell" data-execution_count="106">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(idata, var_names<span class="op">=</span>[<span class="st">"~mu"</span>], figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">40</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="107">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> train_model:</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    idata.extend(pm.sample_posterior_predictive(idata, random_seed<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="109">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>pred_model <span class="op">=</span> create_model(pre_df, post_df, infer_post<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>state_idxs_, states_ <span class="op">=</span> pd.factorize(post_df[<span class="st">"state"</span>])</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pred_model:</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    pm.set_data({</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"time"</span>: post_df[<span class="st">"t"</span>].to_numpy(),</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month"</span>: post_df[<span class="st">"month"</span>].to_numpy(),</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"state_idx"</span>: state_idxs_,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mean temp"</span>: post_df[<span class="st">"mean_temp_st"</span>].to_numpy(),</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temp lag1"</span>: post_df[<span class="st">"min_lt0_lag1"</span>].to_numpy(),</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temp lag2"</span>: post_df[<span class="st">"min_lt0_lag2"</span>].to_numpy(),</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age 70-75"</span>: post_df[<span class="st">"pop_share_70_st"</span>].to_numpy(),</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age 75-80"</span>: post_df[<span class="st">"pop_share_75_st"</span>].to_numpy(),</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age 80+"</span>: post_df[<span class="st">"pop_share_80_st"</span>].to_numpy(),</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flu cases per 100k age 75-79 lag1"</span>: post_df[<span class="st">"flu_cases_75_per100k_lag1_st"</span>].to_numpy(),</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flu cases per 100k age 80+ lag1"</span>: post_df[<span class="st">"flu_cases_80_per100k_lag1_st"</span>].to_numpy(),</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"disease cases per 100k age 75-79"</span>: post_df[<span class="st">"disease_cases_75_per100k_st"</span>].to_numpy(),</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"disease cases per 100k age 80+"</span>: post_df[<span class="st">"disease_cases_80_per100k_st"</span>].to_numpy(),</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    counterfactual <span class="op">=</span> pm.sample_posterior_predictive(</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>        idata, var_names<span class="op">=</span>[<span class="st">"obs"</span>], random_seed<span class="op">=</span><span class="dv">1</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="118">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_state_idx(state):</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    _, states <span class="op">=</span> pd.factorize(df[<span class="st">"state"</span>])</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> states.to_list().index(state)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_hdi_df(preds, hdi_prob_low, hdi_prob_high):</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    hdi_dfs <span class="op">=</span> []</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> kind, prob <span class="kw">in</span> <span class="bu">zip</span>([<span class="st">"low"</span>, <span class="st">"high"</span>], [hdi_prob_low, hdi_prob_high]):</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        hdi_df <span class="op">=</span> (az.hdi(preds, hdi_prob<span class="op">=</span>prob)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>                    .to_dataframe()</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>                    .reset_index()</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>                    .pivot_table(index<span class="op">=</span><span class="st">"obs_id"</span>, columns<span class="op">=</span><span class="st">"hdi"</span>, values<span class="op">=</span><span class="st">"obs"</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>                    .reset_index()</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>                    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>                    .rename(columns<span class="op">=</span>{</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"lower"</span>: <span class="ss">f"</span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss">_lower"</span>,</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"higher"</span>: <span class="ss">f"</span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss">_higher"</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>                    }))</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        hdi_dfs.append(hdi_df)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    hdi_df <span class="op">=</span> pd.merge(left<span class="op">=</span>hdi_dfs[<span class="dv">0</span>], right<span class="op">=</span>hdi_dfs[<span class="dv">1</span>])</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    hdi_df[<span class="st">"pred_mean"</span>] <span class="op">=</span> preds.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>])</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hdi_df</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_posterior_predictive(idata,</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>                             counterfactual,</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>                             state,</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>                             hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>                             hdi_prob_high<span class="op">=</span><span class="fl">0.9</span>):</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    state_idx <span class="op">=</span> get_state_idx(state)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>    pre_pred <span class="op">=</span> (idata.posterior_predictive</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>                     .obs</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>                     .isel(obs_id<span class="op">=</span>idata.constant_data.state_idx <span class="op">==</span> state_idx))</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>    pre_hdi_df <span class="op">=</span> get_hdi_df(pre_pred, hdi_prob_low, hdi_prob_high)</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>    pre_cols <span class="op">=</span> (pre_df.iloc[pre_hdi_df.obs_id.values]</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>                      .loc[:, [<span class="st">"population"</span>, <span class="st">"deaths_total"</span>, <span class="st">"deaths_per100k"</span>, <span class="st">"covid_deaths_per100k"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>, <span class="st">"date"</span>]]</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>                      .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>    pre_hdi_df <span class="op">=</span> pd.concat([pre_hdi_df, pre_cols], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    post_pred <span class="op">=</span> (counterfactual.posterior_predictive</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>                               .obs</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>                               .isel(obs_id<span class="op">=</span>counterfactual.constant_data.state_idx <span class="op">==</span> state_idx))</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>    post_hdi_df <span class="op">=</span> get_hdi_df(post_pred, hdi_prob_low, hdi_prob_high)</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>    post_cols <span class="op">=</span> (post_df.iloc[post_hdi_df.obs_id.values]</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>                        .loc[:, [<span class="st">"population"</span>, <span class="st">"deaths_total"</span>, <span class="st">"deaths_per100k"</span>, <span class="st">"covid_deaths_per100k"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>, <span class="st">"date"</span>]]</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>                        .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>    post_hdi_df <span class="op">=</span> pd.concat([post_hdi_df, post_cols], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat([pre_hdi_df, post_hdi_df], axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="143">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_posterior_predictive(idata, </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                              counterfactual, </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                              state,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                              years<span class="op">=</span>[<span class="dv">2018</span>, <span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>],</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                              hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                              hdi_prob_high<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                              absolute<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>                              response_measures<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>                              dominant_voc<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get full name of state</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    state_name <span class="op">=</span> abbr2name[state]</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load state map</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    state_map <span class="op">=</span> plt.imread(map_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">.png"</span>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    map_box <span class="op">=</span> OffsetImage(state_map, zoom<span class="op">=</span><span class="fl">.14</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load data and select appropriate date range</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> get_posterior_predictive(idata, counterfactual, state, hdi_prob_low, hdi_prob_high)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    first_date <span class="op">=</span> df.date.<span class="bu">max</span>() <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">365</span> <span class="op">*</span> (<span class="bu">len</span>(years)<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.loc[df.date <span class="op">&gt;=</span> first_date]</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    first_month <span class="op">=</span> df.date.dt.month.iloc[<span class="dv">0</span>]</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    first_year <span class="op">=</span> df.date.dt.year.iloc[<span class="dv">0</span>]</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup figure</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">8</span>))</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>        ax.spines[spine].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax.plot(df.date, df.pred_mean, color="#7a0b04")</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Counterfactual estimate and actual deaths since </span><span class="sc">{</span>first_month<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>first_year<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_locator(mdates.MonthLocator((<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">10</span>)))</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_minor_formatter(mdates.DateFormatter(<span class="st">"%b"</span>))</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="fl">11.5</span>)</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim([first_date <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">10</span>), df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">235</span>)])</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot data</span></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df.date, df.high_lower, df.high_higher, color<span class="op">=</span><span class="st">"#f0928b"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df.date, df.low_lower, df.low_higher, color<span class="op">=</span><span class="st">"#d9746c"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>        ax.plot(df.date, df.deaths_per100k, lw<span class="op">=</span><span class="st">"2"</span>, color<span class="op">=</span><span class="st">"#404040"</span>, label<span class="op">=</span><span class="st">"actual deaths"</span>)</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ax.plot(df.date, df.pred_mean + df.covid_deaths_per100k, lw="2", color="blue", label="C19 deaths")</span></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>        ylim_min <span class="op">=</span> df.deaths_per100k.<span class="bu">min</span>() <span class="op">-</span> <span class="dv">2</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>        ylim_max <span class="op">=</span> df.deaths_per100k.<span class="bu">max</span>() <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim((ylim_min, ylim_max))</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>        state_name <span class="op">=</span> state_name <span class="cf">if</span> <span class="kw">not</span> <span class="st">"-"</span> <span class="kw">in</span> state_name <span class="cf">else</span> <span class="st">"-</span><span class="ch">\n</span><span class="st">"</span>.join(state_name.split(<span class="st">"-"</span>))</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>        xt <span class="op">=</span> mdates.date2num(df.date.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">110</span>))</span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>        ax.text(xt, ylim_min <span class="op">+</span> <span class="fl">0.8</span> <span class="op">*</span> (ylim_max <span class="op">-</span> ylim_min), s<span class="op">=</span>state_name, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>        ab <span class="op">=</span> AnnotationBbox(map_box, (xt, ylim_min <span class="op">+</span> <span class="fl">0.65</span> <span class="op">*</span> (ylim_max <span class="op">-</span> ylim_min)), frameon<span class="op">=</span><span class="va">False</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>        ax.add_artist(ab)</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"weekly deaths per 100,000 people"</span>, fontsize<span class="op">=</span><span class="dv">13</span>, labelpad<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>        mul <span class="op">=</span> df.population <span class="op">/</span> <span class="dv">100_000</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df.date, df.high_lower <span class="op">*</span> mul, df.high_higher <span class="op">*</span> mul, color<span class="op">=</span><span class="st">"#f0928b"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(df.date, df.low_lower <span class="op">*</span> mul, df.low_higher <span class="op">*</span> mul, color<span class="op">=</span><span class="st">"#d9746c"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>        ax.plot(df.date, df.deaths_per100k <span class="op">*</span> mul, lw<span class="op">=</span><span class="st">"2"</span>, color<span class="op">=</span><span class="st">"#404040"</span>, label<span class="op">=</span><span class="st">"actual deaths"</span>)</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>        ylim_min <span class="op">=</span> df.deaths_per100k.mul(mul).<span class="bu">min</span>() <span class="op">*</span> <span class="fl">0.9</span></span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>        ylim_max <span class="op">=</span> df.deaths_per100k.mul(mul).<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.1</span></span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim((ylim_min, ylim_max))</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>        state_name <span class="op">=</span> state_name <span class="cf">if</span> <span class="kw">not</span> <span class="st">"-"</span> <span class="kw">in</span> state_name <span class="cf">else</span> <span class="st">"-</span><span class="ch">\n</span><span class="st">"</span>.join(state_name.split(<span class="st">"-"</span>))</span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>        xt <span class="op">=</span> mdates.date2num(df.date.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">110</span>))</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a>        ax.text(xt, ylim_min <span class="op">+</span> <span class="fl">0.8</span> <span class="op">*</span> (ylim_max <span class="op">-</span> ylim_min), s<span class="op">=</span>state_name, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>        ab <span class="op">=</span> AnnotationBbox(map_box, (xt, ylim_min <span class="op">+</span> <span class="fl">0.65</span> <span class="op">*</span> (ylim_max <span class="op">-</span> ylim_min)), frameon<span class="op">=</span><span class="va">False</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>        ax.add_artist(ab)</span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"weekly deaths"</span>, fontsize<span class="op">=</span><span class="dv">13</span>, labelpad<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot response measures</span></span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response_measures:</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> start, end, level <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">9</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">5</span>, day<span class="op">=</span><span class="dv">5</span>), <span class="dv">2</span>),</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">11</span>, day<span class="op">=</span><span class="dv">2</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">8</span>), <span class="dv">1</span>),</span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">9</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">5</span>, day<span class="op">=</span><span class="dv">31</span>), <span class="dv">2</span>),</span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">11</span>, day<span class="op">=</span><span class="dv">24</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">19</span>), <span class="dv">1</span>)]:</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a>            level2color <span class="op">=</span> {</span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>                <span class="dv">2</span>: <span class="st">"#d97914"</span>,</span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>: <span class="st">"#fcdb44"</span></span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> mdates.date2num(start)</span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> mdates.date2num(end)</span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> end <span class="op">-</span> start</span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a>                anchor <span class="op">=</span> (start, df.deaths_per100k.<span class="bu">min</span>() <span class="op">-</span> <span class="dv">2</span>)</span>
<span id="cb47-90"><a href="#cb47-90" aria-hidden="true" tabindex="-1"></a>                height <span class="op">=</span> df.deaths_per100k.<span class="bu">max</span>() <span class="op">-</span> df.deaths_per100k.<span class="bu">min</span>() <span class="op">+</span> <span class="fl">2.25</span></span>
<span id="cb47-91"><a href="#cb47-91" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb47-92"><a href="#cb47-92" aria-hidden="true" tabindex="-1"></a>                anchor <span class="op">=</span> (start, ylim_min)</span>
<span id="cb47-93"><a href="#cb47-93" aria-hidden="true" tabindex="-1"></a>                height <span class="op">=</span> (df.deaths_per100k.mul(mul).<span class="bu">max</span>() <span class="op">-</span> df.deaths_per100k.mul(mul).<span class="bu">min</span>()) <span class="op">*</span> <span class="fl">1.2</span></span>
<span id="cb47-94"><a href="#cb47-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-95"><a href="#cb47-95" aria-hidden="true" tabindex="-1"></a>            rect <span class="op">=</span> patches.Rectangle(xy<span class="op">=</span>anchor, width<span class="op">=</span>width, height<span class="op">=</span>height, </span>
<span id="cb47-96"><a href="#cb47-96" aria-hidden="true" tabindex="-1"></a>                                     color<span class="op">=</span>level2color[level], hatch<span class="op">=</span><span class="st">"//"</span>, </span>
<span id="cb47-97"><a href="#cb47-97" aria-hidden="true" tabindex="-1"></a>                                     fill<span class="op">=</span><span class="va">None</span>, lw<span class="op">=</span><span class="dv">0</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb47-98"><a href="#cb47-98" aria-hidden="true" tabindex="-1"></a>            ax.add_patch(rect)</span>
<span id="cb47-99"><a href="#cb47-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-100"><a href="#cb47-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot dominant variants</span></span>
<span id="cb47-101"><a href="#cb47-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dominant_voc:</span>
<span id="cb47-102"><a href="#cb47-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb47-103"><a href="#cb47-103" aria-hidden="true" tabindex="-1"></a>            ymax <span class="op">=</span> df.deaths_per100k.<span class="bu">max</span>() <span class="op">+</span> <span class="fl">1.25</span></span>
<span id="cb47-104"><a href="#cb47-104" aria-hidden="true" tabindex="-1"></a>            line_ymax <span class="op">=</span> ymax <span class="op">-</span> <span class="fl">0.25</span></span>
<span id="cb47-105"><a href="#cb47-105" aria-hidden="true" tabindex="-1"></a>            arrow_y <span class="op">=</span> ymax</span>
<span id="cb47-106"><a href="#cb47-106" aria-hidden="true" tabindex="-1"></a>            text_y <span class="op">=</span> ymax <span class="op">+</span> <span class="fl">0.25</span></span>
<span id="cb47-107"><a href="#cb47-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb47-108"><a href="#cb47-108" aria-hidden="true" tabindex="-1"></a>            ymax <span class="op">=</span> ylim_max <span class="op">*</span> <span class="fl">0.95</span></span>
<span id="cb47-109"><a href="#cb47-109" aria-hidden="true" tabindex="-1"></a>            line_ymax <span class="op">=</span> ymax</span>
<span id="cb47-110"><a href="#cb47-110" aria-hidden="true" tabindex="-1"></a>            arrow_y <span class="op">=</span> ymax <span class="op">*</span> <span class="fl">1.0075</span></span>
<span id="cb47-111"><a href="#cb47-111" aria-hidden="true" tabindex="-1"></a>            text_y <span class="op">=</span> ymax <span class="op">*</span> <span class="fl">1.015</span></span>
<span id="cb47-112"><a href="#cb47-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-113"><a href="#cb47-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, desc, <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">1</span>, day<span class="op">=</span><span class="dv">27</span>), </span>
<span id="cb47-114"><a href="#cb47-114" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"First case detected</span><span class="ch">\n</span><span class="st"> in Germany"</span>)]:</span>
<span id="cb47-115"><a href="#cb47-115" aria-hidden="true" tabindex="-1"></a>            ax.vlines(t, ylim_min, line_ymax, color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb47-116"><a href="#cb47-116" aria-hidden="true" tabindex="-1"></a>            ax.text(t, text_y <span class="op">*</span> <span class="fl">0.99</span>, s<span class="op">=</span>desc, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb47-117"><a href="#cb47-117" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-118"><a href="#cb47-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, desc <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">1</span>), <span class="st">"Alpha"</span>),</span>
<span id="cb47-119"><a href="#cb47-119" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">6</span>, day<span class="op">=</span><span class="dv">20</span>), <span class="st">"Delta"</span>),</span>
<span id="cb47-120"><a href="#cb47-120" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">20</span>), <span class="st">"BA. 1"</span>),</span>
<span id="cb47-121"><a href="#cb47-121" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">1</span>), <span class="st">"BA. 2"</span>),</span>
<span id="cb47-122"><a href="#cb47-122" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">6</span>, day<span class="op">=</span><span class="dv">10</span>), <span class="st">"BA. 5"</span>)]:</span>
<span id="cb47-123"><a href="#cb47-123" aria-hidden="true" tabindex="-1"></a>            ax.vlines(t, ylim_min, line_ymax, color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb47-124"><a href="#cb47-124" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> mdates.date2num(t <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">21</span>)) <span class="op">-</span> mdates.date2num(t)</span>
<span id="cb47-125"><a href="#cb47-125" aria-hidden="true" tabindex="-1"></a>            head_width <span class="op">=</span> <span class="fl">0.2</span> <span class="cf">if</span> <span class="kw">not</span> absolute <span class="cf">else</span> ymax <span class="op">*</span> <span class="fl">0.0075</span></span>
<span id="cb47-126"><a href="#cb47-126" aria-hidden="true" tabindex="-1"></a>            ax.arrow(t, arrow_y, </span>
<span id="cb47-127"><a href="#cb47-127" aria-hidden="true" tabindex="-1"></a>                        dx<span class="op">=</span>width, dy<span class="op">=</span><span class="dv">0</span>, </span>
<span id="cb47-128"><a href="#cb47-128" aria-hidden="true" tabindex="-1"></a>                        head_width<span class="op">=</span>head_width, </span>
<span id="cb47-129"><a href="#cb47-129" aria-hidden="true" tabindex="-1"></a>                        head_length<span class="op">=</span>width<span class="op">*</span><span class="fl">0.3</span>, </span>
<span id="cb47-130"><a href="#cb47-130" aria-hidden="true" tabindex="-1"></a>                        lw<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb47-131"><a href="#cb47-131" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb47-132"><a href="#cb47-132" aria-hidden="true" tabindex="-1"></a>            ax.text(t, text_y, s<span class="op">=</span>desc, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb47-133"><a href="#cb47-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-134"><a href="#cb47-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-135"><a href="#cb47-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot legend</span></span>
<span id="cb47-136"><a href="#cb47-136" aria-hidden="true" tabindex="-1"></a>    ax.legend(facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can now plot our counterfactual estimate against the actually recorded number of deaths again, but this time for individual states. Let’s have a look at Bavaria, for instance:</p>
<div class="cell" data-execution_count="146">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>plot_posterior_predictive(idata, counterfactual, state<span class="op">=</span><span class="st">"by"</span>, absolute<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-45-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="132">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cf_hdi_df(preds, hdi_prob_low, hdi_prob_high):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    hdi_dfs <span class="op">=</span> []</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> kind, prob <span class="kw">in</span> <span class="bu">zip</span>([<span class="st">"low"</span>, <span class="st">"high"</span>], [hdi_prob_low, hdi_prob_high]):</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>        hdi_df <span class="op">=</span> (az.hdi(preds, hdi_prob<span class="op">=</span>prob)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                    .to_dataframe()</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                    .reset_index()</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                    .pivot_table(index<span class="op">=</span><span class="st">"obs_id"</span>, columns<span class="op">=</span><span class="st">"hdi"</span>, values<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                    .reset_index()</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                    .rename(columns<span class="op">=</span>{</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"lower"</span>: <span class="ss">f"</span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss">_lower"</span>,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"higher"</span>: <span class="ss">f"</span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss">_higher"</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>                    }))</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        hdi_dfs.append(hdi_df)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    hdi_df <span class="op">=</span> pd.merge(left<span class="op">=</span>hdi_dfs[<span class="dv">0</span>], right<span class="op">=</span>hdi_dfs[<span class="dv">1</span>])</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    hdi_df[<span class="st">"pred_mean"</span>] <span class="op">=</span> preds.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>])</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    post_cols <span class="op">=</span> (post_df.iloc[hdi_df.obs_id.values]</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>                        .loc[:, [<span class="st">"population"</span>, <span class="st">"deaths_total"</span>, <span class="st">"deaths_per100k"</span>, <span class="st">"covid_deaths_per100k"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>, <span class="st">"date"</span>]]</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>                        .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    hdi_df <span class="op">=</span> pd.concat([hdi_df, post_cols], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hdi_df</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_excess_deaths(state):</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    state_idx <span class="op">=</span> get_state_idx(state)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    cf <span class="op">=</span> (counterfactual.posterior_predictive</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>                        .obs</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>                        .isel(obs_id<span class="op">=</span>counterfactual.constant_data.state_idx <span class="op">==</span> state_idx))</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    deaths <span class="op">=</span> xr.DataArray(post_df[post_df.state <span class="op">==</span> state][<span class="st">"deaths_per100k"</span>].to_numpy(), dims<span class="op">=</span>[<span class="st">"obs_id"</span>])</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    excess_deaths <span class="op">=</span> deaths <span class="op">-</span> cf</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>    cum_excess <span class="op">=</span> excess_deaths.cumsum(dim<span class="op">=</span><span class="st">"obs_id"</span>)</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess_deaths.transpose(..., <span class="st">"obs_id"</span>), cum_excess.transpose(..., <span class="st">"obs_id"</span>)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_excess_deaths(state, </span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>                       hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>                       hdi_prob_high<span class="op">=</span><span class="fl">0.9</span>, </span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>                       absolute<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>                       dominant_voc<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>                       response_measures<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get full name of state</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>    state_name <span class="op">=</span> abbr2name[state]</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>    state_name <span class="op">=</span> state_name <span class="cf">if</span> <span class="kw">not</span> <span class="st">"-"</span> <span class="kw">in</span> state_name <span class="cf">else</span> <span class="st">"-</span><span class="ch">\n</span><span class="st">"</span>.join(state_name.split(<span class="st">"-"</span>))</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load state map</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>    state_map <span class="op">=</span> plt.imread(map_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">.png"</span>)</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>    map_box <span class="op">=</span> OffsetImage(state_map, zoom<span class="op">=</span><span class="fl">.14</span>)</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>    excess_deaths, cumsum <span class="op">=</span> get_excess_deaths(state)</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">9</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>        ax[i].tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"top"</span>, <span class="st">"right"</span>]:</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>            ax[i].spines[spine].set_visible(<span class="va">False</span>)</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> [<span class="st">"bottom"</span>, <span class="st">"left"</span>]:</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>            ax[i].spines[spine].set_linewidth(<span class="fl">1.2</span>)</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>            ax[i].spines[<span class="st">"bottom"</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>            ax[i].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, bottom<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">0</span>].set_title(<span class="ss">f"Excess deaths since 01/20"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>    excess_df <span class="op">=</span> get_cf_hdi_df(excess_deaths, hdi_prob_low, hdi_prob_high)</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>    xlim_min <span class="op">=</span> pd.Timestamp(year<span class="op">=</span><span class="dv">2019</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>    xlim_max <span class="op">=</span> excess_df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">180</span>)</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a>        ax[i].set_xlim((xlim_min, xlim_max))</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>        excess_ylim_min <span class="op">=</span> excess_df.high_lower.<span class="bu">min</span>() <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>        excess_ylim_max <span class="op">=</span> excess_df.high_higher.<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].fill_between(excess_df.date, excess_df.high_lower, excess_df.high_higher, color<span class="op">=</span><span class="st">"#f0928b"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].fill_between(excess_df.date, excess_df.low_lower, excess_df.low_higher, color<span class="op">=</span><span class="st">"#d9746c"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].plot(excess_df.date, excess_df.covid_deaths_per100k, lw<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"#44454a"</span>, label<span class="op">=</span><span class="st">"official</span><span class="ch">\n</span><span class="st">C19 deaths"</span>)</span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].hlines(y<span class="op">=</span><span class="dv">0</span>, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">1.5</span>, ls<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].set_ylabel(<span class="st">"weekly excess deaths per 100,000 people"</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>        xt <span class="op">=</span> mdates.date2num(excess_df.date.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">110</span>))</span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].text(xt, excess_ylim_min <span class="op">+</span> <span class="fl">0.82</span> <span class="op">*</span> (excess_ylim_max <span class="op">-</span> excess_ylim_min), s<span class="op">=</span>state_name, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a>        ab <span class="op">=</span> AnnotationBbox(map_box, (xt, excess_ylim_min <span class="op">+</span> <span class="fl">0.57</span> <span class="op">*</span> (excess_ylim_max <span class="op">-</span> excess_ylim_min)), frameon<span class="op">=</span><span class="va">False</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].add_artist(ab)</span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: </span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>        mul <span class="op">=</span> excess_df.population <span class="op">/</span> <span class="dv">100_000</span></span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a>        excess_ylim_min <span class="op">=</span> excess_df.high_lower.mul(mul).<span class="bu">min</span>() <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a>        excess_ylim_max <span class="op">=</span> excess_df.high_higher.mul(mul).<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].fill_between(excess_df.date, excess_df.high_lower.mul(mul), excess_df.high_higher.mul(mul), color<span class="op">=</span><span class="st">"#f0928b"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].fill_between(excess_df.date, excess_df.low_lower.mul(mul), excess_df.low_higher.mul(mul), color<span class="op">=</span><span class="st">"#d9746c"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].plot(excess_df.date, excess_df.covid_deaths_per100k.mul(mul), lw<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"#44454a"</span>, label<span class="op">=</span><span class="st">"official</span><span class="ch">\n</span><span class="st">C19 deaths"</span>)</span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].hlines(y<span class="op">=</span><span class="dv">0</span>, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">1.5</span>, ls<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].set_ylabel(<span class="st">"weekly excess deaths"</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a>        xt <span class="op">=</span> mdates.date2num(excess_df.date.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">110</span>))</span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].text(xt, excess_ylim_min <span class="op">+</span> <span class="fl">0.82</span> <span class="op">*</span> (excess_ylim_max <span class="op">-</span> excess_ylim_min), s<span class="op">=</span>state_name, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a>        ab <span class="op">=</span> AnnotationBbox(map_box, (xt, excess_ylim_min <span class="op">+</span> <span class="fl">0.57</span> <span class="op">*</span> (excess_ylim_max <span class="op">-</span> excess_ylim_min)), frameon<span class="op">=</span><span class="va">False</span>, zorder<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].add_artist(ab)</span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> ax[<span class="dv">0</span>].get_yticks()[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].hlines(y<span class="op">=</span>y, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">"#a1a1a1"</span>, zorder<span class="op">=-</span><span class="dv">10</span>)</span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">0</span>].legend(facecolor<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, loc<span class="op">=</span><span class="st">"lower right"</span>)</span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot response measures</span></span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response_measures:</span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> start, end, level <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">9</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">5</span>, day<span class="op">=</span><span class="dv">5</span>), <span class="dv">2</span>),</span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">11</span>, day<span class="op">=</span><span class="dv">2</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">8</span>), <span class="dv">1</span>),</span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">9</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">5</span>, day<span class="op">=</span><span class="dv">31</span>), <span class="dv">2</span>),</span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>                                  (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">11</span>, day<span class="op">=</span><span class="dv">24</span>), pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">19</span>), <span class="dv">1</span>)]:</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a>            level2color <span class="op">=</span> {</span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a>                <span class="dv">2</span>: <span class="st">"#d97914"</span>,</span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>: <span class="st">"#fcdb44"</span></span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> mdates.date2num(start)</span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> mdates.date2num(end)</span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a>            anchor <span class="op">=</span> (start, excess_ylim_min <span class="op">*</span> <span class="fl">0.8</span>)</span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> end <span class="op">-</span> start</span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> (excess_ylim_max <span class="op">-</span> excess_ylim_min) <span class="op">*</span> <span class="fl">0.8</span></span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>            rect <span class="op">=</span> patches.Rectangle(xy<span class="op">=</span>anchor, width<span class="op">=</span>width, height<span class="op">=</span>height, </span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a>                                     color<span class="op">=</span>level2color[level], hatch<span class="op">=</span><span class="st">"//"</span>, </span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a>                                     fill<span class="op">=</span><span class="va">None</span>, lw<span class="op">=</span><span class="dv">0</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>].add_patch(rect)</span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot dominant variants</span></span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dominant_voc:</span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, desc, <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2020</span>, month<span class="op">=</span><span class="dv">1</span>, day<span class="op">=</span><span class="dv">27</span>), </span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"First case detected</span><span class="ch">\n</span><span class="st"> in Germany"</span>)]:</span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>].vlines(t, excess_ylim_min <span class="op">*</span> <span class="fl">0.8</span>, excess_ylim_max <span class="op">*</span> <span class="fl">0.8</span>, color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>].text(t <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">20</span>), excess_ylim_min <span class="op">*</span> <span class="fl">1.1</span>, s<span class="op">=</span>desc, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t, desc <span class="kw">in</span> [(pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">1</span>), <span class="st">"Alpha"</span>),</span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">6</span>, day<span class="op">=</span><span class="dv">20</span>), <span class="st">"Delta"</span>),</span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2021</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">20</span>), <span class="st">"BA. 1"</span>),</span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">3</span>, day<span class="op">=</span><span class="dv">1</span>), <span class="st">"BA. 2"</span>),</span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a>                        (pd.Timestamp(year<span class="op">=</span><span class="dv">2022</span>, month<span class="op">=</span><span class="dv">6</span>, day<span class="op">=</span><span class="dv">10</span>), <span class="st">"BA. 5"</span>)]:</span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a>                ax[<span class="dv">0</span>].vlines(t, excess_ylim_min <span class="op">*</span> <span class="fl">0.8</span>, excess_ylim_max <span class="op">*</span> <span class="fl">0.8</span>, color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a>                width <span class="op">=</span> mdates.date2num(t <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">14</span>)) <span class="op">-</span> mdates.date2num(t)</span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a>                head_width <span class="op">=</span> <span class="fl">0.5</span> <span class="cf">if</span> <span class="kw">not</span> absolute <span class="cf">else</span> excess_ylim_max <span class="op">*</span> <span class="fl">0.02</span></span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a>                ax[<span class="dv">0</span>].arrow(t, excess_ylim_min <span class="op">*</span> <span class="fl">0.85</span>, </span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a>                            dx<span class="op">=</span>width, dy<span class="op">=</span><span class="dv">0</span>, </span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>head_width, </span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a>                            head_length<span class="op">=</span>width<span class="op">*</span><span class="fl">0.3</span>, </span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a>                            lw<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a>                            color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a>                ax[<span class="dv">0</span>].text(t, excess_ylim_min <span class="op">*</span> <span class="dv">1</span>, s<span class="op">=</span>desc, ha<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb49-146"><a href="#cb49-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-147"><a href="#cb49-147" aria-hidden="true" tabindex="-1"></a>    cumsum_df <span class="op">=</span> get_cf_hdi_df(cumsum, hdi_prob_low, hdi_prob_high)</span>
<span id="cb49-148"><a href="#cb49-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> absolute:</span>
<span id="cb49-149"><a href="#cb49-149" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].fill_between(cumsum_df.date, cumsum_df.high_lower, cumsum_df.high_higher, color<span class="op">=</span><span class="st">"#f0928b"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb49-150"><a href="#cb49-150" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].fill_between(cumsum_df.date, cumsum_df.low_lower,cumsum_df.low_higher, color<span class="op">=</span><span class="st">"#d9746c"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb49-151"><a href="#cb49-151" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].plot(cumsum_df.date, cumsum_df.covid_deaths_per100k.cumsum(), lw<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"#44454a"</span>, label<span class="op">=</span><span class="st">"cumulative</span><span class="ch">\n</span><span class="st">C19 deaths"</span>)</span>
<span id="cb49-152"><a href="#cb49-152" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].hlines(y<span class="op">=</span><span class="dv">0</span>, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">1.5</span>, ls<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb49-153"><a href="#cb49-153" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].set_ylabel(<span class="st">"cumulative excess deaths per 100,000 people"</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb49-154"><a href="#cb49-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb49-155"><a href="#cb49-155" aria-hidden="true" tabindex="-1"></a>        mul <span class="op">=</span> cumsum_df.population <span class="op">/</span> <span class="dv">100_000</span></span>
<span id="cb49-156"><a href="#cb49-156" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].fill_between(cumsum_df.date, cumsum_df.high_lower.mul(mul), cumsum_df.high_higher.mul(mul), color<span class="op">=</span><span class="st">"#f0928b"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_high <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb49-157"><a href="#cb49-157" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].fill_between(cumsum_df.date, cumsum_df.low_lower.mul(mul),cumsum_df.low_higher.mul(mul), color<span class="op">=</span><span class="st">"#d9746c"</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>hdi_prob_low <span class="op">*</span> <span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% CI"</span>)</span>
<span id="cb49-158"><a href="#cb49-158" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].plot(cumsum_df.date, cumsum_df.covid_deaths_per100k.mul(mul).cumsum(), lw<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"#44454a"</span>, label<span class="op">=</span><span class="st">"cumulative</span><span class="ch">\n</span><span class="st">C19 deaths"</span>)</span>
<span id="cb49-159"><a href="#cb49-159" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].hlines(y<span class="op">=</span><span class="dv">0</span>, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">1.5</span>, ls<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb49-160"><a href="#cb49-160" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].set_ylabel(<span class="st">"cumulative excess deaths"</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb49-161"><a href="#cb49-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-162"><a href="#cb49-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> ax[<span class="dv">1</span>].get_yticks()[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb49-163"><a href="#cb49-163" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>].hlines(y<span class="op">=</span>y, xmin<span class="op">=</span>xlim_min, xmax<span class="op">=</span>excess_df.date.<span class="bu">max</span>(), lw<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">"#a1a1a1"</span>, zorder<span class="op">=-</span><span class="dv">10</span>)</span>
<span id="cb49-164"><a href="#cb49-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-165"><a href="#cb49-165" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].xaxis.set_minor_locator(mdates.MonthLocator(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)))</span>
<span id="cb49-166"><a href="#cb49-166" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].xaxis.set_minor_formatter(mdates.DateFormatter(<span class="st">"%b"</span>))</span>
<span id="cb49-167"><a href="#cb49-167" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb49-168"><a href="#cb49-168" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"both"</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb49-169"><a href="#cb49-169" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"minor"</span>, labelsize<span class="op">=</span><span class="fl">9.5</span>)</span>
<span id="cb49-170"><a href="#cb49-170" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, labelsize<span class="op">=</span><span class="fl">11.5</span>)</span>
<span id="cb49-171"><a href="#cb49-171" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].set_xlim([pd.Timestamp(year<span class="op">=</span><span class="dv">2019</span>, month<span class="op">=</span><span class="dv">12</span>, day<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">10</span>), df.date.<span class="bu">max</span>() <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">200</span>)])</span>
<span id="cb49-172"><a href="#cb49-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-173"><a href="#cb49-173" aria-hidden="true" tabindex="-1"></a>    plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.1</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>What is probably more interesting, though, is looking at <em>excess</em> mortality specifically. This time, I also included the cumulative estimated excess deaths over the course of the pandemic in the bottom part of the plot. Note that the scales of the y-axis are not the same for different states!</p>
<div class="cell" data-execution_count="141">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>plot_excess_deaths(<span class="st">"bw"</span>, absolute<span class="op">=</span><span class="va">False</span>, dominant_voc<span class="op">=</span><span class="va">False</span>, response_measures<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-47-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="142">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>plot_excess_deaths(<span class="st">"sn"</span>, absolute<span class="op">=</span><span class="va">False</span>, dominant_voc<span class="op">=</span><span class="va">False</span>, response_measures<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-48-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Finally, we can put the model’s estimates in a pandas DataFrame to get a better summary. As we can see, there are marked differences between the German states:</p>
<div class="cell" data-execution_count="160">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_states_excess(hdi_prob_low<span class="op">=</span><span class="fl">0.5</span>, hdi_prob_high<span class="op">=</span><span class="fl">0.9</span>):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    states <span class="op">=</span> []</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    excess <span class="op">=</span> []</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> state <span class="kw">in</span> post_df.state.unique():</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        _, cumsum <span class="op">=</span> get_excess_deaths(state)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        cumsum_df <span class="op">=</span> get_cf_hdi_df(cumsum, hdi_prob_low, hdi_prob_high)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        mul <span class="op">=</span> cumsum_df.population <span class="op">/</span> <span class="dv">100_000</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>        states.append(state)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>        excess.append(cumsum_df.pred_mean.iloc[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"state"</span>: states,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"excess_deaths_per100k"</span>: excess,</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>        df.assign(state<span class="op">=</span><span class="kw">lambda</span> df_: df_.state.<span class="bu">map</span>(abbr2name))</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>          .astype({<span class="st">"excess_deaths_per100k"</span>: <span class="st">"int"</span>})</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>          .sort_values(by<span class="op">=</span><span class="st">"excess_deaths_per100k"</span>)</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>          .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="161">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>get_states_excess()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="161">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">excess_deaths_per100k</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Berlin</td>
<td>149</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Baden-Württemberg</td>
<td>204</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Mecklenburg-Western Pomerania</td>
<td>217</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Hamburg</td>
<td>227</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Schleswig-Holstein</td>
<td>234</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Rhineland-Palatinate</td>
<td>256</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Bavaria</td>
<td>279</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Hesse</td>
<td>297</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Lower Saxony</td>
<td>305</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Bremen</td>
<td>327</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>North Rhine-Westphalia</td>
<td>357</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Saarland</td>
<td>375</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Brandenburg</td>
<td>436</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Thuringia</td>
<td>437</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Saxony</td>
<td>447</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Saxony-Anhalt</td>
<td>502</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>